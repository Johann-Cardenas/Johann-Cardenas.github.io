<!DOCTYPE HTML>
<html>
<head>
    <script>
        (function() {
            var theme = localStorage.getItem('aircrafter-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            // Ensure the global theme-toggle.js respects the app default
            localStorage.setItem('theme-preference', theme);
        })();
    </script>
    <title>AirCrafter | Contact Stress Engine</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../assets/css/main.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* ==================== THEME VARIABLES ==================== */
        :root {
            --ac-primary: #0ea5e9;
            --ac-primary-hover: #0284c7;
            --ac-primary-glow: rgba(14, 165, 233, 0.3);
            --ac-secondary: #f97316;
            --ac-secondary-hover: #ea580c;
            --ac-accent: #8b5cf6;
            --ac-success: #10b981;
            --ac-warning: #f59e0b;
            --ac-danger: #ef4444;
            --ac-info: #06b6d4;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --ac-radius: 14px;
            --ac-gap: 0.75rem;
        }

        [data-theme="light"] {
            --ac-bg: #ffffff;
            --ac-bg-alt: #f8fafc;
            --ac-bg-panel: #e9eff5;
            --ac-bg-dark: #0c1425;
            --ac-text: #0f172a;
            --ac-text-secondary: #374151;
            --ac-text-muted: #506070;
            --ac-border: #c0ccd8;
            --ac-border-dark: #8896a4;
            --ac-card-shadow: 0 4px 12px -2px rgb(0 0 0 / 0.1), 0 1px 3px rgb(0 0 0 / 0.06);
            --glass-bg: rgba(0, 0, 0, 0.04);
            --glass-border: rgba(0, 0, 0, 0.10);
            --ac-primary-glow: rgba(14, 165, 233, 0.2);
        }

        [data-theme="dark"] {
            --ac-bg: #0f172a;
            --ac-bg-alt: #0c1425;
            --ac-bg-panel: #1e293b;
            --ac-bg-dark: #0c1425;
            --ac-text: #f1f5f9;
            --ac-text-secondary: #e2e8f0;
            --ac-text-muted: #a8b8cc;
            --ac-border: #3b4f6b;
            --ac-border-dark: #546a84;
            --ac-card-shadow: 0 4px 12px -2px rgb(0 0 0 / 0.4), 0 1px 3px rgb(0 0 0 / 0.3);
        }

        /* ==================== SCROLLBAR ==================== */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--ac-bg-alt); }
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--ac-primary), var(--ac-primary-hover));
            border-radius: 4px;
        }
        * { scrollbar-width: thin; scrollbar-color: var(--ac-primary) var(--ac-bg-alt); }

        /* ==================== ANIMATIONS ==================== */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-6px); }
        }
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px var(--ac-primary-glow), 0 0 10px transparent; }
            50% { box-shadow: 0 0 20px var(--ac-primary-glow), 0 0 40px var(--ac-primary-glow); }
        }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.92); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideRight {
            from { opacity: 0; transform: translateX(-15px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 12px rgba(14, 165, 233, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
        }
        @keyframes countUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }
        @keyframes particles {
            0% { transform: translateX(0); }
            100% { transform: translateX(-500px); }
        }
        @keyframes ripple {
            to { transform: scale(4); opacity: 0; }
        }
        @keyframes borderGlow {
            0%, 100% { border-color: var(--ac-border); }
            50% { border-color: var(--ac-primary); }
        }
        .stagger-1 { animation-delay: 0.05s; }
        .stagger-2 { animation-delay: 0.10s; }
        .stagger-3 { animation-delay: 0.15s; }
        .stagger-4 { animation-delay: 0.20s; }
        .stagger-5 { animation-delay: 0.25s; }
        .stagger-6 { animation-delay: 0.30s; }
        .animate-in {
            animation: slideInUp 0.4s cubic-bezier(0.22, 1, 0.36, 1) both;
        }
        .count-animate {
            animation: countUp 0.5s cubic-bezier(0.22, 1, 0.36, 1) both;
        }

        /* ==================== GLASSMORPHISM ==================== */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }

        /* ==================== HOVER EFFECTS ==================== */
        .hover-lift {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
        }
        .hover-lift:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        }

        /* ==================== GRADIENT TEXT ==================== */
        .gradient-text {
            background: linear-gradient(135deg, var(--ac-primary), var(--ac-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }

        /* ==================== GLOBAL RESET ==================== */
        * { box-sizing: border-box; }
        html, body { margin: 0 !important; padding: 0 !important; }
        html { scroll-behavior: smooth; }
        body { font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, sans-serif; }
        #wrapper, #main, .wrapper, main { padding-top: 0 !important; margin-top: 0 !important; }
        #header, section#header { display: none !important; }
        #titleBar { background: transparent !important; }
        #titleBar .toggle { display: none !important; }
        #navPanel { display: none !important; }

        /* ==================== APP CONTAINER ==================== */
        .aircrafter-app {
            max-width: 1500px;
            margin: 0 auto;
            padding: 0.75rem 1.5rem 2rem;
            background: var(--ac-bg);
            min-height: 100vh;
        }

        /* ==================== HEADER (Frontier-style centered) ==================== */
        .app-header {
            margin-bottom: 1.25rem;
            background: linear-gradient(135deg, #0c1425 0%, #1a2744 50%, #0f2040 100%);
            border-radius: 24px;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .app-header::before {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, var(--ac-primary-glow) 0%, transparent 40%),
                radial-gradient(circle at 80% 20%, rgba(249, 115, 22, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(14, 165, 233, 0.08) 0%, transparent 60%);
            pointer-events: none;
            animation: headerGlow 8s ease-in-out infinite alternate;
        }
        @keyframes headerGlow { 0% { opacity: 0.8; } 100% { opacity: 1; } }
        .app-header::after {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-image:
                radial-gradient(2px 2px at 20px 30px, rgba(255,255,255,0.3), transparent),
                radial-gradient(2px 2px at 80px 70px, rgba(255,255,255,0.2), transparent),
                radial-gradient(2px 2px at 160px 40px, rgba(255,255,255,0.3), transparent),
                radial-gradient(3px 3px at 250px 100px, var(--ac-primary), transparent),
                radial-gradient(2px 2px at 350px 50px, rgba(255,255,255,0.2), transparent),
                radial-gradient(3px 3px at 420px 30px, var(--ac-secondary), transparent);
            background-size: 450px 150px;
            animation: particles 20s linear infinite;
            pointer-events: none;
        }
        .header-nav {
            padding: 0.85rem 1.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative; z-index: 1;
            backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: space-between;
        }
        .back-btn {
            background: rgba(14, 165, 233, 0.2);
            border: 1px solid rgba(14, 165, 233, 0.4);
            color: white; padding: 0.5rem 1rem; border-radius: 10px;
            cursor: pointer; font-size: 0.88rem;
            display: inline-flex; align-items: center; gap: 0.5rem;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            text-decoration: none; font-weight: 500;
        }
        .back-btn:hover {
            background: rgba(14, 165, 233, 0.35);
            border-color: rgba(14, 165, 233, 0.6);
            transform: translateX(-3px);
            box-shadow: 0 4px 15px var(--ac-primary-glow);
        }
        .back-btn:hover i { transform: translateX(-3px); }
        .back-btn i { transition: transform 0.3s ease; }
        .header-badges {
            display: flex; align-items: center; gap: 0.5rem;
            margin-left: auto;
        }
        .header-badge {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.15);
            padding: 0.35rem 0.75rem; border-radius: 8px;
            font-size: 0.78rem; font-weight: 600;
            color: rgba(255,255,255,0.75);
            letter-spacing: 0.03em;
        }
        .header-badge i { margin-right: 0.3rem; font-size: 0.72rem; }
        .header-content {
            text-align: center;
            padding: 1.5rem 2rem 1.75rem;
            position: relative; z-index: 1;
        }
        .header-content h1 {
            font-size: 3rem; margin: 0 0 0.5rem; display: flex;
            align-items: center; justify-content: center; gap: 0.8rem;
            font-weight: 800; color: white !important;
            text-shadow: 0 2px 20px rgba(0, 0, 0, 0.3);
            animation: slideInUp 0.8s ease;
        }
        .header-content h1 .plane-icon {
            color: var(--ac-primary) !important;
            font-size: 2.2rem;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 10px var(--ac-primary-glow));
        }
        .header-content h1 .highlight {
            background: linear-gradient(135deg, var(--ac-primary), var(--ac-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .header-content p {
            font-size: 1.15rem; opacity: 0.9; margin: 0;
            color: white !important; font-weight: 300;
            letter-spacing: 0.5px;
            animation: slideInUp 0.8s ease 0.1s both;
        }

        /* ==================== MODULE TABS ==================== */
        .module-tabs {
            display: flex; gap: 0.3rem; margin-bottom: 1rem;
            background: var(--ac-bg-panel); padding: 0.35rem; border-radius: 12px;
            border: 1px solid var(--ac-border);
        }
        .module-tab {
            flex: 1; padding: 0.7rem 0.9rem; border-radius: 9px;
            background: transparent !important; border: none;
            color: var(--ac-text-muted) !important; font-weight: 600; font-size: 0.92rem;
            cursor: pointer; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 0.4rem;
            position: relative; overflow: hidden;
            box-shadow: none;
        }
        .module-tab:hover { color: var(--ac-text) !important; background: rgba(14, 165, 233, 0.08) !important; }
        .module-tab.active {
            background: linear-gradient(135deg, var(--ac-primary), var(--ac-primary-hover)) !important;
            color: white !important;
            box-shadow: 0 4px 16px var(--ac-primary-glow);
            transform: translateY(-1px);
        }
        .module-tab .tab-badge {
            font-size: 0.65rem; background: rgba(255,255,255,0.2);
            padding: 0.1rem 0.4rem; border-radius: 4px; font-weight: 700;
        }
        [data-theme="light"] .module-tab .tab-badge {
            background: rgba(14, 165, 233, 0.12);
            color: var(--ac-primary-hover);
        }
        .module-tab.active .tab-badge { background: rgba(255,255,255,0.25); }
        [data-theme="light"] .module-tab.active .tab-badge {
            background: rgba(255,255,255,0.3);
            color: white;
        }
        .module-content { display: none; animation: fadeIn 0.35s ease; }
        .module-content.active { display: block; }

        /* ==================== PANEL (compact) ==================== */
        .panel {
            background: var(--ac-bg-panel);
            border: 1px solid var(--ac-border);
            border-radius: var(--ac-radius); padding: 1rem 1.1rem;
            margin-bottom: var(--ac-gap);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
        }
        .panel:hover {
            border-color: var(--ac-border-dark);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .panel-title {
            font-size: 1.1rem; font-weight: 700;
            color: var(--ac-text); margin: 0 0 0.7rem;
            display: flex; align-items: center; gap: 0.4rem;
        }
        .panel-title i { color: var(--ac-primary); font-size: 0.95rem; }

        /* ==================== CONFIG LAYOUT (2-col) ==================== */
        .config-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: var(--ac-gap);
            align-items: start;
        }
        .config-left, .config-right {
            display: flex; flex-direction: column; gap: var(--ac-gap);
        }
        .config-right { position: sticky; top: 1rem; }

        /* ==================== SELECTION ==================== */
        .selection-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr;
            gap: 0.7rem;
        }
        .filter-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .filter-group label {
            font-size: 0.85rem; font-weight: 700; color: var(--ac-text-muted);
            text-transform: uppercase; letter-spacing: 0.06em;
        }
        .filter-group select,
        .filter-group input[type="text"] {
            padding: 0.6rem 0.8rem; border-radius: 8px;
            border: 1px solid var(--ac-border);
            background: var(--ac-bg); color: var(--ac-text);
            font-size: 1rem; transition: all 0.3s ease; font-family: inherit;
        }
        .filter-group select:focus,
        .filter-group input[type="text"]:focus {
            outline: none; border-color: var(--ac-primary);
            box-shadow: 0 0 0 3px var(--ac-primary-glow), 0 2px 8px rgba(14,165,233,0.1);
        }

        /* ==================== INLINE STATS (compact badges) ==================== */
        .inline-stats {
            display: flex; flex-wrap: wrap; gap: 0.4rem;
            margin-bottom: 0.5rem;
        }
        .mini-stat {
            display: inline-flex; align-items: center; gap: 0.4rem;
            background: var(--ac-bg); border: 1px solid var(--ac-border);
            padding: 0.4rem 0.75rem; border-radius: 8px;
            font-size: 0.92rem; transition: all 0.3s ease;
        }
        .mini-stat:hover {
            border-color: var(--ac-primary);
            background: rgba(14,165,233,0.06);
        }
        .mini-stat .ms-icon { font-size: 0.72rem; }
        .mini-stat .ms-value { font-weight: 800; color: var(--ac-text); font-variant-numeric: tabular-nums; }
        .mini-stat .ms-label { color: var(--ac-text-muted); font-weight: 500; }
        .mini-stat.eq-pass { border-color: rgba(16,185,129,0.4); background: rgba(16,185,129,0.06); }
        .mini-stat.eq-fail { border-color: rgba(239,68,68,0.4); background: rgba(239,68,68,0.06); }
        .mini-stat.eq-pass .ms-value { color: var(--ac-success); }
        .mini-stat.eq-fail .ms-value { color: var(--ac-danger); }

        /* ==================== PARAMETER CARDS (compact) ==================== */
        .params-grid {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 0.6rem; margin-bottom: 0.8rem;
        }
        .param-card {
            background: var(--ac-bg); border: 1px solid var(--ac-border);
            border-radius: 10px; padding: 0.6rem 0.8rem;
            transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .param-card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, var(--ac-primary), var(--ac-info)); opacity: 0.6;
        }
        .param-card:hover {
            border-color: var(--ac-primary);
            box-shadow: 0 4px 16px rgba(14,165,233,0.12);
            transform: translateY(-1px);
        }
        .param-card .label {
            font-size: 0.85rem; font-weight: 700; color: var(--ac-text-muted);
            text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 0.2rem;
        }
        .param-card .unit {
            font-size: 0.85rem; font-weight: 400; color: var(--ac-text-secondary);
        }
        .param-card input {
            width: 100%; font-size: 1.25rem; font-weight: 700;
            padding: 0.25rem 0.4rem; border-radius: 6px;
            border: 1px solid var(--ac-border);
            background: var(--ac-bg-alt); color: var(--ac-text);
            font-family: inherit; transition: border-color 0.3s ease;
        }
        .param-card input:focus {
            outline: none; border-color: var(--ac-primary);
            box-shadow: 0 0 0 2px var(--ac-primary-glow);
        }
        .param-card.modified::after {
            content: '●'; position: absolute; top: 6px; right: 8px;
            color: var(--ac-warning); font-size: 0.7rem;
        }

        /* ==================== RIB TABLE (compact) ==================== */
        .rib-table-container { overflow-x: auto; }
        .rib-table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            font-size: 0.95rem;
        }
        .rib-table th {
            background: var(--ac-bg); color: var(--ac-text-secondary);
            padding: 0.5rem 0.6rem; text-align: center;
            font-weight: 700; font-size: 0.82rem;
            text-transform: uppercase; letter-spacing: 0.04em;
            border-bottom: 2px solid var(--ac-border);
        }
        .rib-table td {
            padding: 0.3rem 0.4rem; text-align: center;
            border-bottom: 1px solid var(--ac-border);
        }
        .rib-table td input {
            width: 78px; text-align: center;
            padding: 0.3rem 0.35rem; border-radius: 6px;
            border: 1px solid var(--ac-border);
            background: var(--ac-bg-alt); color: var(--ac-text);
            font-size: 0.88rem; font-family: inherit; transition: all 0.3s ease;
        }
        .rib-table td input:focus {
            outline: none; border-color: var(--ac-primary);
            box-shadow: 0 0 0 2px var(--ac-primary-glow);
        }
        .rib-table td input.modified {
            border-color: var(--ac-warning); background: rgba(245, 158, 11, 0.08);
        }
        .rib-table tr:hover td { background: rgba(14, 165, 233, 0.03); }
        .rib-header-cell { font-weight: 700; color: var(--ac-primary-hover) !important; white-space: nowrap; }
        [data-theme="light"] .rib-header-cell { color: #0369a1 !important; }

        /* ==================== BUTTONS ==================== */
        .btn {
            padding: 0.65rem 1.3rem; border-radius: 10px;
            font-weight: 600; font-size: 1rem; cursor: pointer;
            display: inline-flex; align-items: center; gap: 0.4rem;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: none; font-family: inherit; position: relative; overflow: hidden;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--ac-primary), var(--ac-primary-hover));
            color: white; box-shadow: 0 4px 16px var(--ac-primary-glow);
        }
        .btn-primary:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 28px var(--ac-primary-glow);
            filter: brightness(1.08);
        }
        .btn-warning {
            background: linear-gradient(135deg, var(--ac-warning), var(--ac-secondary));
            color: white;
        }
        .btn-warning:hover { transform: translateY(-1px); }
        .btn-outline {
            background: transparent !important; border: 1px solid var(--ac-border);
            color: var(--ac-text-secondary) !important;
            box-shadow: none;
        }
        .btn-outline:hover { border-color: var(--ac-primary); color: var(--ac-text) !important; background: rgba(14, 165, 233, 0.08) !important; }
        .btn-group { display: flex; gap: 0.5rem; }

        /* Ripple effect */
        .btn .ripple-effect {
            position: absolute; border-radius: 50%; background: rgba(255,255,255,0.3);
            transform: scale(0); animation: ripple 0.6s linear; pointer-events: none;
        }

        /* ==================== RESULTS SUMMARY TABLE ==================== */
        .results-table {
            width: 100%; font-size: 0.92rem; border-collapse: collapse;
        }
        .results-table th {
            text-align: left; padding: 0.45rem 0.6rem;
            color: var(--ac-text-muted); font-weight: 600;
            font-size: 0.8rem; text-transform: uppercase;
            letter-spacing: 0.04em;
            border-bottom: 1px solid var(--ac-border);
        }
        .results-table td {
            padding: 0.3rem 0.5rem; border-bottom: 1px solid var(--ac-border);
            color: var(--ac-text);
        }
        .results-table td.val {
            font-weight: 700; font-variant-numeric: tabular-nums;
            text-align: right;
        }
        .results-table .rib-row:hover td {
            background: rgba(14,165,233,0.06);
            transition: background 0.2s ease;
        }

        /* ==================== CHART CONTAINERS ==================== */
        .charts-row { display: grid; grid-template-columns: 1fr; gap: var(--ac-gap); }
        .charts-row.two-col { grid-template-columns: repeat(2, 1fr); }
        .charts-row.three-col { grid-template-columns: repeat(3, 1fr); }
        .chart-panel {
            background: var(--ac-bg-panel); border: 1px solid var(--ac-border);
            border-radius: var(--ac-radius); overflow: hidden;
            transition: border-color 0.3s ease;
        }
        .chart-panel:hover { border-color: var(--ac-border-dark); }
        .chart-header {
            padding: 0.55rem 1rem;
            border-bottom: 1px solid var(--ac-border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .chart-title {
            font-weight: 700; font-size: 1rem; color: var(--ac-text);
            display: flex; align-items: center; gap: 0.4rem;
        }
        .chart-title i { color: var(--ac-primary); font-size: 0.88rem; }
        .chart-subtitle {
            font-size: 0.85rem; color: var(--ac-text-muted); font-weight: 500;
        }
        .chart-body { padding: 0.3rem; min-height: 480px; overflow: hidden; max-width: 100%; }
        .chart-body-tall { min-height: 560px; }
        .chart-body-short { min-height: 420px; }

        /* ==================== CONTACT PATCH SVG ==================== */
        .contact-patch-container {
            display: flex; justify-content: center; align-items: center;
            padding: 1rem; min-height: 320px;
        }
        #contact-patch-svg { max-width: 100%; height: auto; min-height: 280px; max-height: 380px; }

        /* ==================== LOADING OVERLAY ==================== */
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999; backdrop-filter: blur(4px);
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .loading-overlay.visible { opacity: 1; pointer-events: all; }
        .loading-card {
            background: var(--ac-bg-panel); border: 1px solid var(--ac-border);
            border-radius: 20px; padding: 2.2rem 2.8rem; text-align: center;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4);
            animation: scaleIn 0.3s ease; min-width: 300px;
        }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--ac-border);
            border-top-color: var(--ac-primary); border-radius: 50%;
            animation: rotate 0.8s linear infinite; margin: 0 auto 1rem;
        }
        .loading-text { color: var(--ac-text); font-weight: 600; font-size: 1.05rem; }
        /* Selection Loading Card */
        .selection-loading-card {
            background: var(--ac-bg-panel); border: 1px solid var(--ac-border);
            border-radius: 20px; padding: 2rem 2.5rem; text-align: center;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4);
            animation: scaleIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1); min-width: 320px; max-width: 400px;
        }
        .selection-loading-card .aircraft-name {
            font-size: 1.3rem; font-weight: 800; color: var(--ac-text);
            margin: 0.8rem 0 0.4rem;
        }
        .selection-loading-card .aircraft-name .highlight {
            background: linear-gradient(135deg, var(--ac-primary), var(--ac-secondary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .selection-loading-card .loading-plane {
            font-size: 2.2rem; color: var(--ac-primary);
            animation: float 1.5s ease-in-out infinite;
            filter: drop-shadow(0 0 12px var(--ac-primary-glow));
        }
        .selection-loading-card .loading-steps {
            margin: 1rem 0 0; text-align: left;
        }
        .selection-loading-card .loading-step {
            display: flex; align-items: center; gap: 0.6rem;
            padding: 0.35rem 0; font-size: 0.92rem; color: var(--ac-text-muted);
            transition: all 0.3s ease;
        }
        .selection-loading-card .loading-step.active {
            color: var(--ac-text); font-weight: 600;
        }
        .selection-loading-card .loading-step.done {
            color: var(--ac-success);
        }
        .selection-loading-card .loading-step i {
            width: 18px; text-align: center; font-size: 0.85rem;
        }
        .selection-loading-card .loading-step.active i {
            color: var(--ac-primary);
        }
        .selection-loading-card .loading-step.done i { color: var(--ac-success); }
        .progress-container { width: 100%; margin: 0.4rem 0 0.6rem; }
        .progress-bar-track {
            width: 100%; height: 6px; background: var(--ac-border);
            border-radius: 3px; overflow: hidden;
        }
        .progress-bar-fill {
            width: 0%; height: 100%;
            background: linear-gradient(90deg, var(--ac-primary), var(--ac-secondary));
            border-radius: 3px; transition: width 0.15s ease;
        }
        .progress-pct {
            text-align: center; font-size: 0.72rem; margin-top: 0.3rem;
            color: var(--ac-text-muted); font-weight: 600;
        }

        /* ==================== EMPTY STATE ==================== */
        .empty-state {
            text-align: center; padding: 2.5rem 1rem; color: var(--ac-text-muted);
        }
        .empty-state i { font-size: 2.8rem; margin-bottom: 0.7rem; opacity: 0.35; }
        .empty-state p { font-size: 1.05rem; margin: 0.3rem 0; }

        /* ==================== ADVANCED SETTINGS ==================== */
        .advanced-toggle {
            display: flex; align-items: center; gap: 0.4rem;
            cursor: pointer; color: var(--ac-text-muted);
            font-size: 0.92rem; font-weight: 600;
            margin-top: 0.6rem; transition: color 0.3s ease; user-select: none;
        }
        .advanced-toggle:hover { color: var(--ac-primary); }
        .advanced-toggle i { transition: transform 0.3s ease; font-size: 0.7rem; }
        .advanced-toggle.open i { transform: rotate(90deg); }
        .advanced-body { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
        .advanced-body.open { max-height: 500px; }
        .advanced-grid {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem; padding-top: 0.6rem;
        }
        .adv-input-group { display: flex; flex-direction: column; gap: 0.15rem; }
        .adv-input-group label {
            font-size: 0.75rem; font-weight: 600; color: var(--ac-text-muted);
        }
        .adv-input-group input {
            padding: 0.4rem 0.55rem; border-radius: 6px;
            border: 1px solid var(--ac-border);
            background: var(--ac-bg); color: var(--ac-text);
            font-size: 0.88rem; font-family: inherit;
        }
        .adv-input-group input:focus {
            outline: none; border-color: var(--ac-primary);
            box-shadow: 0 0 0 2px var(--ac-primary-glow);
        }

        /* ==================== VIZ SUBTABS ==================== */
        .viz-tabs { display: flex; gap: 0.25rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
        .viz-tab {
            padding: 0.5rem 0.9rem; border-radius: 7px;
            background: transparent !important; border: 1px solid var(--ac-border);
            color: var(--ac-text-muted) !important; cursor: pointer;
            font-size: 0.92rem; font-weight: 600;
            transition: all 0.3s ease; font-family: inherit;
            box-shadow: none;
        }
        .viz-tab:hover { border-color: var(--ac-primary); color: var(--ac-text) !important; background: rgba(14, 165, 233, 0.08) !important; }
        .viz-tab.active {
            background: var(--ac-primary) !important; color: white !important; border-color: var(--ac-primary);
        }
        .viz-content { display: none; animation: fadeIn 0.3s ease; }
        .viz-content.active { display: block; }

        /* ==================== TOOLTIPS ==================== */
        .tooltip-trigger { position: relative; cursor: help; }
        .tooltip-trigger::after {
            content: attr(data-tooltip);
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-4px);
            background: var(--ac-bg-dark); color: #e2e8f0; padding: 0.3rem 0.6rem;
            border-radius: 6px; font-size: 0.72rem; white-space: nowrap;
            opacity: 0; pointer-events: none; transition: opacity 0.2s ease;
            z-index: 100;
        }
        .tooltip-trigger:hover::after { opacity: 1; }

        /* ==================== SUCCESS FLASH ==================== */
        .success-flash {
            position: fixed; top: 1rem; right: 1rem; z-index: 10000;
            background: var(--ac-success); color: white;
            padding: 0.6rem 1.2rem; border-radius: 10px;
            font-weight: 600; font-size: 0.88rem;
            display: flex; align-items: center; gap: 0.5rem;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
            animation: slideRight 0.3s ease, fadeIn 0.3s ease;
            transition: opacity 0.4s ease;
        }

        /* ==================== KEYBOARD SHORTCUT HINT ==================== */
        .kbd-hint {
            font-size: 0.65rem; color: var(--ac-text-muted);
            background: var(--ac-bg); border: 1px solid var(--ac-border);
            padding: 0.1rem 0.35rem; border-radius: 4px;
            font-family: monospace; margin-left: 0.4rem;
        }

        /* ==================== LIGHT MODE OVERRIDES ==================== */
        [data-theme="light"] .panel {
            box-shadow: var(--ac-card-shadow);
        }
        [data-theme="light"] .panel:hover {
            box-shadow: 0 6px 24px -4px rgb(0 0 0 / 0.12), 0 2px 6px rgb(0 0 0 / 0.06);
        }
        [data-theme="light"] .chart-panel {
            box-shadow: var(--ac-card-shadow);
        }
        [data-theme="light"] .module-tab:hover {
            background: rgba(14, 165, 233, 0.12);
            color: var(--ac-primary-hover) !important;
        }
        [data-theme="light"] .module-tab {
            color: #1e293b !important;
            font-weight: 700;
        }
        [data-theme="light"] .mini-stat:hover {
            background: rgba(14, 165, 233, 0.10);
        }
        [data-theme="light"] .rib-table tr:hover td {
            background: rgba(14, 165, 233, 0.08);
        }
        [data-theme="light"] .results-table .rib-row:hover td {
            background: rgba(14, 165, 233, 0.10);
        }
        [data-theme="light"] .results-table td {
            border-bottom: 1px solid var(--ac-border);
        }
        [data-theme="light"] .results-table th {
            color: var(--ac-text-secondary);
            border-bottom: 2px solid var(--ac-border-dark);
        }
        [data-theme="light"] .empty-state i {
            opacity: 0.55;
        }
        [data-theme="light"] .empty-state p {
            color: var(--ac-text-secondary);
        }
        [data-theme="light"] .param-card::before {
            opacity: 1;
        }
        [data-theme="light"] .param-card {
            box-shadow: 0 1px 3px rgb(0 0 0 / 0.06);
        }
        [data-theme="light"] .param-card:hover {
            box-shadow: 0 4px 16px rgba(14,165,233,0.15);
        }
        [data-theme="light"] .loading-card {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15), 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        [data-theme="light"] .selection-loading-card {
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.15), 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        [data-theme="light"] .filter-group label {
            color: var(--ac-text-secondary);
        }
        [data-theme="light"] .adv-input-group label {
            color: var(--ac-text-secondary);
        }
        [data-theme="light"] .param-card .label {
            color: var(--ac-text-secondary);
        }
        [data-theme="light"] .mini-stat .ms-label {
            color: var(--ac-text-secondary);
        }
        [data-theme="light"] .viz-tab {
            color: var(--ac-text-secondary) !important;
        }
        [data-theme="light"] .viz-tab:hover {
            border-color: var(--ac-primary);
            color: var(--ac-text) !important;
            background: rgba(14, 165, 233, 0.08);
        }
        [data-theme="light"] .advanced-toggle {
            color: var(--ac-text-secondary);
        }
        [data-theme="light"] .chart-subtitle {
            color: var(--ac-text-secondary);
        }
        [data-theme="light"] .progress-pct {
            color: var(--ac-text-secondary);
        }
        [data-theme="light"] .kbd-hint {
            color: var(--ac-text-secondary);
            background: var(--ac-bg-panel);
            border-color: var(--ac-border-dark);
        }
        [data-theme="light"] .selection-loading-card .loading-step {
            color: var(--ac-text-secondary);
        }
        [data-theme="light"] .btn-outline {
            color: var(--ac-text-secondary) !important;
            border-color: var(--ac-border-dark);
        }
        [data-theme="light"] .btn-outline:hover {
            background: rgba(14, 165, 233, 0.08);
        }
        [data-theme="light"] .rib-table th {
            color: var(--ac-text-secondary);
            background: var(--ac-bg-panel);
        }
        [data-theme="light"] .mini-stat {
            box-shadow: 0 1px 2px rgb(0 0 0 / 0.04);
        }
        [data-theme="light"] .filter-group select,
        [data-theme="light"] .filter-group input[type="text"] {
            box-shadow: inset 0 1px 2px rgb(0 0 0 / 0.05);
        }
        [data-theme="light"] .rib-table td input {
            box-shadow: inset 0 1px 2px rgb(0 0 0 / 0.05);
        }
        [data-theme="light"] .param-card input {
            box-shadow: inset 0 1px 2px rgb(0 0 0 / 0.05);
        }
        [data-theme="light"] .adv-input-group input {
            box-shadow: inset 0 1px 2px rgb(0 0 0 / 0.05);
        }
        [data-theme="light"] .loading-overlay {
            background: rgba(0, 0, 0, 0.35);
        }
        [data-theme="light"] .tooltip-trigger::after {
            background: #1e293b;
            color: #f1f5f9;
        }

        /* ==================== DARK MODE OVERRIDES ==================== */
        [data-theme="dark"] .module-tab {
            color: #c8d5e3 !important;
        }
        [data-theme="dark"] .module-tab:hover {
            color: #f1f5f9 !important;
            background: rgba(14, 165, 233, 0.14);
        }
        [data-theme="dark"] .viz-tab {
            color: #c8d5e3 !important;
            border-color: var(--ac-border);
        }
        [data-theme="dark"] .viz-tab:hover {
            color: #f1f5f9 !important;
            border-color: var(--ac-primary);
            background: rgba(14, 165, 233, 0.10);
        }
        [data-theme="dark"] .panel {
            box-shadow: var(--ac-card-shadow);
        }
        [data-theme="dark"] .chart-panel {
            box-shadow: var(--ac-card-shadow);
        }
        [data-theme="dark"] .chart-subtitle {
            color: var(--ac-text-secondary);
        }
        [data-theme="dark"] .filter-group label {
            color: #c8d5e3;
        }
        [data-theme="dark"] .param-card .label {
            color: #c8d5e3;
        }
        [data-theme="dark"] .adv-input-group label {
            color: #c8d5e3;
        }
        [data-theme="dark"] .mini-stat .ms-label {
            color: var(--ac-text-secondary);
        }
        [data-theme="dark"] .results-table th {
            color: var(--ac-text-secondary);
        }
        [data-theme="dark"] .btn-outline {
            color: var(--ac-text-secondary) !important;
            border-color: var(--ac-border-dark);
        }
        [data-theme="dark"] .advanced-toggle {
            color: var(--ac-text-secondary);
        }
        [data-theme="dark"] .empty-state i {
            opacity: 0.45;
        }
        [data-theme="dark"] .empty-state p {
            color: var(--ac-text-secondary);
        }

        /* ==================== RESPONSIVE ==================== */
        @media (max-width: 1200px) {
            .config-layout { grid-template-columns: 1fr; }
            .config-right { position: static; }
        }
        @media (max-width: 1024px) {
            .params-grid { grid-template-columns: repeat(3, 1fr); }
            .charts-row.two-col { grid-template-columns: 1fr; }
            .charts-row.three-col { grid-template-columns: 1fr; }
            .advanced-grid { grid-template-columns: repeat(2, 1fr); }
            .contact-patch-container { min-height: 400px; padding: 1rem; }
        }
        @media (max-width: 768px) {
            .aircrafter-app { padding: 0.5rem 0.75rem 1.5rem; padding-top: 2.25rem; }
            /* Collapse header-nav bar; float back-btn into the titleBar row */
            .header-nav {
                padding: 0; height: 0; overflow: visible;
                background: none; border: none; backdrop-filter: none;
            }
            .header-badges { display: none; }
            /* back-btn is moved into #titleBar by JS on mobile */
            .header-nav .back-btn { display: none !important; }
            #titleBar .back-btn {
                position: absolute !important; top: 5px !important; left: 10px !important; right: auto !important;
                font-size: 0.8rem !important; padding: 0.4rem 0.85rem !important;
                background: rgba(14, 165, 233, 0.25) !important;
                border: 1px solid rgba(14, 165, 233, 0.45) !important;
                backdrop-filter: blur(10px); border-radius: 8px !important;
                color: white !important; width: auto !important;
                display: inline-flex !important; align-items: center !important; gap: 0.4rem !important;
                height: auto !important; line-height: normal !important;
                text-decoration: none !important; font-weight: 500 !important;
                white-space: nowrap !important;
            }
            #titleBar .back-btn i { font-size: 0.72rem; }
            #titleBar .back-btn:hover { transform: none !important; box-shadow: none !important; }
            .header-content { padding: 1.2rem 1.2rem 1.5rem; }
            .header-content h1 { font-size: 2.2rem; gap: 0.5rem; }
            .header-content h1 .plane-icon { font-size: 1.6rem; }
            .header-content p { font-size: 1.05rem; }
            .module-tabs { flex-wrap: wrap; }
            .module-tab { font-size: 0.82rem; padding: 0.55rem 0.6rem; }
            .module-tab i { display: none; }
            .params-grid { grid-template-columns: 1fr; }
            .selection-grid { grid-template-columns: 1fr; }
            .panel { padding: 0.85rem 0.9rem; overflow: hidden; max-width: 100%; }
            .panel-title { font-size: 1rem; }
            .inline-stats { gap: 0.35rem; }
            .mini-stat { font-size: 0.82rem; padding: 0.3rem 0.55rem; }
            .contact-patch-container { min-height: 360px; padding: 0.75rem; }
            #contact-patch-svg { min-height: 320px; }
            .chart-panel { overflow: hidden; max-width: 100%; }
            .chart-body { min-height: 350px; }
            .chart-body-tall { min-height: 420px; }
            .chart-body-short { min-height: 300px; }
            .chart-body .js-plotly-plot, .chart-body .plot-container { max-width: 100% !important; }
            .results-table { font-size: 0.82rem; display: block; overflow-x: auto; }
            .results-table th { font-size: 0.72rem; }
            #summary-matrix-body { overflow-x: auto; }
            .rib-table td input { width: 65px; font-size: 0.82rem; }
            .advanced-grid { grid-template-columns: repeat(2, 1fr); }
            .viz-tab { font-size: 0.82rem; padding: 0.4rem 0.65rem; }
            .btn { font-size: 0.92rem; padding: 0.55rem 1rem; }
            .loading-card { min-width: 240px; padding: 1.5rem 1.8rem; }
            .selection-loading-card { min-width: 260px; padding: 1.5rem 1.8rem; }
            #btn-export-xlsx { font-size: 0.8rem !important; padding: 0.4rem 0.8rem !important; }
        }
        @media (max-width: 480px) {
            .aircrafter-app { padding: 0.35rem 0.5rem 1rem; padding-top: 2.25rem; }
            .header-content h1 { font-size: 1.8rem; }
            .header-content p { font-size: 0.92rem; }
            .header-nav { padding: 0.6rem 0.8rem; flex-wrap: wrap; gap: 0.5rem; }
            .module-tab { font-size: 0.75rem; padding: 0.45rem 0.4rem; flex: 1 1 45%; }
            .param-card .label { font-size: 0.75rem; }
            .param-card input { font-size: 1.1rem; }
            .contact-patch-container { min-height: 280px; }
            .advanced-grid { grid-template-columns: 1fr 1fr; gap: 0.4rem; }
            .selection-loading-card { min-width: 220px; }
            .chart-body { min-height: 300px; }
            .chart-body-tall { min-height: 360px; }
            .chart-body-short { min-height: 260px; }
            .chart-header { padding: 0.4rem 0.6rem; flex-wrap: wrap; gap: 0.3rem; }
            .chart-title { font-size: 0.88rem; }
            .chart-subtitle { font-size: 0.75rem; }
            .viz-tabs { flex-wrap: wrap; gap: 0.25rem; }
        }

        /* ===== Plotly mobile fixes ===== */
        @media (max-width: 768px) {
            .js-plotly-plot .plotly .modebar { transform: scale(0.75); transform-origin: top right; }
            .js-plotly-plot, .plot-container.plotly { max-width: 100% !important; width: 100% !important; }
            .svg-container { max-width: 100% !important; }
        }
        @media (max-width: 480px) {
            .js-plotly-plot .plotly .modebar { transform: scale(0.65); transform-origin: top right; }
        }
    </style>
</head>

<body>
    <div id="page-wrapper">
        <section id="header"><div id="nav-placeholder"></div></section>

        <section id="main">
            <div class="aircrafter-app">

                <!-- ===== HEADER ===== -->
                <div class="app-header">
                    <div class="header-nav">
                        <a href="../../E-Labs.html" class="back-btn">
                            <i class="fas fa-arrow-left"></i> Back to E-Labs
                        </a>
                        <div class="header-badges">
                            <span class="header-badge"><i class="fas fa-database"></i> <span id="db-count">—</span> Aircraft</span>
                            <span class="header-badge"><i class="fas fa-code-branch"></i> v2.0</span>
                        </div>
                    </div>
                    <div class="header-content">
                        <h1>
                            <span class="plane-icon"><i class="fas fa-plane"></i></span><span>Air<span class="highlight">Crafter</span></span>
                        </h1>
                        <p>Aircraft Tire Contact Stress Analysis Engine</p>
                    </div>
                </div>

                <!-- ===== MODULE TABS ===== -->
                <div class="module-tabs">
                    <button class="module-tab active" data-module="config">
                        <i class="fas fa-sliders-h"></i> Configuration
                    </button>
                    <button class="module-tab" data-module="stress3d">
                        <i class="fas fa-cube"></i> 3D Stress Surfaces
                    </button>
                    <button class="module-tab" data-module="analysis">
                        <i class="fas fa-chart-area"></i> Distribution Analysis
                    </button>
                    <button class="module-tab" data-module="summary">
                        <i class="fas fa-table-list"></i> Results Summary
                    </button>
                </div>

                <!-- ============================================= -->
                <!-- TAB 1: CONFIGURATION (2-col layout)            -->
                <!-- ============================================= -->
                <div class="module-content active" id="module-config">
                    <!-- Aircraft Selection (full width) -->
                    <div class="panel animate-in">
                        <div class="panel-title"><i class="fas fa-search"></i> Aircraft Selection</div>
                        <div class="selection-grid">
                            <div class="filter-group">
                                <label>Manufacturer</label>
                                <select id="filter-manufacturer"><option value="all">All Manufacturers</option></select>
                            </div>
                            <div class="filter-group">
                                <label>Aircraft Model</label>
                                <select id="filter-aircraft"><option value="">— Select Aircraft —</option></select>
                            </div>
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="aircraft-search" placeholder="Type to filter..." />
                            </div>
                        </div>
                    </div>

                    <div class="config-layout">
                        <!-- LEFT: Parameters -->
                        <div class="config-left">
                            <div class="panel animate-in stagger-1" id="param-panel" style="display:none;">
                                <div class="panel-title">
                                    <i class="fas fa-edit"></i> Input Parameters
                                    <span style="flex:1"></span>
                                    <button class="btn btn-warning" id="btn-reset" style="padding:0.3rem 0.7rem; font-size:0.75rem;">
                                        <i class="fas fa-rotate-left"></i> Reset
                                    </button>
                                </div>
                                <div class="params-grid">
                                    <div class="param-card" id="card-P">
                                        <div class="label">P — Load</div>
                                        <input type="number" id="input-P" step="any" />
                                        <div><span class="unit">N</span></div>
                                    </div>
                                    <div class="param-card" id="card-TiP">
                                        <div class="label">TiP — Tire Pressure</div>
                                        <input type="number" id="input-TiP" step="any" />
                                        <div><span class="unit">MPa</span></div>
                                    </div>
                                    <div class="param-card" id="card-l">
                                        <div class="label">l — Contact Length</div>
                                        <input type="number" id="input-l" step="any" />
                                        <div><span class="unit">mm</span></div>
                                    </div>
                                </div>
                                <div class="panel-title" style="margin-top:0.3rem; font-size:0.85rem;">
                                    <i class="fas fa-table-cells"></i> Rib Parameters
                                </div>
                                <div class="rib-table-container">
                                    <table class="rib-table" id="rib-table">
                                        <thead><tr id="rib-table-header"></tr></thead>
                                        <tbody id="rib-table-body"></tbody>
                                    </table>
                                </div>
                                <div class="advanced-toggle" id="adv-toggle">
                                    <i class="fas fa-chevron-right"></i> Advanced Settings
                                </div>
                                <div class="advanced-body" id="adv-body">
                                    <div class="advanced-grid">
                                        <div class="adv-input-group">
                                            <label>SSY Factor</label>
                                            <input type="number" id="adv-ssy" value="0.40" step="0.01" />
                                        </div>
                                        <div class="adv-input-group">
                                            <label>Elements (xn)</label>
                                            <input type="number" id="adv-xn" value="10" min="4" max="100" step="1" />
                                        </div>
                                        <div class="adv-input-group">
                                            <label>Partitions (nnz)</label>
                                            <input type="number" id="adv-nnz" value="2" min="1" max="4" step="1" />
                                        </div>
                                        <div class="adv-input-group">
                                            <label>SSX Pos Peak</label>
                                            <input type="number" id="adv-lsx-pos" value="0.20" step="0.01" />
                                        </div>
                                        <div class="adv-input-group">
                                            <label>SSX Neg Peak</label>
                                            <input type="number" id="adv-lsx-neg" value="0.85" step="0.01" />
                                        </div>
                                        <div class="adv-input-group">
                                            <label>SSX Pos Mag</label>
                                            <input type="number" id="adv-sx-posmag" value="0.20" step="0.01" />
                                        </div>
                                        <div class="adv-input-group">
                                            <label>SSX Neg Mag</label>
                                            <input type="number" id="adv-sx-negmag" value="-0.15" step="0.01" />
                                        </div>
                                        <div class="adv-input-group">
                                            <label>Transition (skpb)</label>
                                            <input type="number" id="adv-skpb" value="0.60" step="0.01" />
                                        </div>
                                    </div>
                                </div>
                                <div class="btn-group" style="margin-top:0.8rem;">
                                    <button class="btn btn-primary" id="btn-compute" style="flex:1;">
                                        <i class="fas fa-bolt"></i> Compute Stresses
                                        <span class="kbd-hint">Ctrl+Enter</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- RIGHT: Stats + Quick Results -->
                        <div class="config-right">
                            <div class="panel animate-in stagger-2" id="stats-panel" style="display:none;">
                                <div class="panel-title"><i class="fas fa-tachometer-alt"></i> Quick Summary</div>
                                <div class="inline-stats" id="inline-stats">
                                    <div class="mini-stat"><span class="ms-icon" style="color:var(--ac-primary)"><i class="fas fa-plane"></i></span> <span class="ms-value" id="stat-aircraft">—</span></div>
                                    <div class="mini-stat"><span class="ms-icon" style="color:var(--ac-secondary)"><i class="fas fa-weight-hanging"></i></span> <span class="ms-value" id="stat-load">—</span> <span class="ms-label">kN</span></div>
                                    <div class="mini-stat"><span class="ms-icon" style="color:var(--ac-info)"><i class="fas fa-gauge-high"></i></span> <span class="ms-value" id="stat-pressure">—</span></div>
                                    <div class="mini-stat"><span class="ms-icon" style="color:var(--ac-accent)"><i class="fas fa-ruler-horizontal"></i></span> <span class="ms-value" id="stat-length">—</span> <span class="ms-label">mm</span></div>
                                    <div class="mini-stat"><span class="ms-icon" style="color:var(--ac-success)"><i class="fas fa-layer-group"></i></span> <span class="ms-value" id="stat-ribs">—</span> <span class="ms-label">ribs</span></div>
                                    <div class="mini-stat" id="eq-stat"><span class="ms-icon" style="color:var(--ac-warning)"><i class="fas fa-scale-balanced"></i></span> <span class="ms-value" id="stat-eq">—</span></div>
                                </div>
                            </div>

                            <div class="panel animate-in stagger-3" id="quick-results-panel" style="display:none;">
                                <div class="panel-title"><i class="fas fa-clipboard-check"></i> Equilibrium Check</div>
                                <div id="quick-results-body"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Patch (full width below the 2-col layout) -->
                    <div class="panel animate-in stagger-4" id="patch-panel" style="display:none;">
                        <div class="panel-title"><i class="fas fa-shoe-prints"></i> Contact Patch</div>
                        <div class="contact-patch-container">
                            <svg id="contact-patch-svg" viewBox="0 0 810 500" xmlns="http://www.w3.org/2000/svg"></svg>
                        </div>
                    </div>
                </div>

                <!-- ============================================= -->
                <!-- TAB 2: 3D STRESS SURFACES                     -->
                <!-- ============================================= -->
                <div class="module-content" id="module-stress3d">
                    <div id="stress3d-empty" class="empty-state">
                        <i class="fas fa-cube"></i>
                        <p><strong>No Data Yet</strong></p>
                        <p>Select an aircraft and compute stresses first.</p>
                    </div>
                    <div id="stress3d-content" style="display:none;">
                        <div class="viz-tabs" id="surface-tabs">
                            <button class="viz-tab active" data-surface="all"><i class="fas fa-layer-group"></i> All Surfaces</button>
                            <button class="viz-tab" data-surface="ssz"><i class="fas fa-arrow-down"></i> σ<sub>z</sub> Vertical</button>
                            <button class="viz-tab" data-surface="ssx"><i class="fas fa-arrow-right"></i> σ<sub>x</sub> Longitudinal</button>
                            <button class="viz-tab" data-surface="ssy"><i class="fas fa-arrows-left-right"></i> σ<sub>y</sub> Transverse</button>
                        </div>
                        <div id="surface-all">
                            <div class="charts-row three-col">
                                <div class="chart-panel">
                                    <div class="chart-header">
                                        <div><div class="chart-title"><i class="fas fa-arrow-down"></i> σ<sub>z</sub></div><div class="chart-subtitle">Vertical Contact Stress</div></div>
                                    </div>
                                    <div class="chart-body" id="chart-3d-ssz-sm"></div>
                                </div>
                                <div class="chart-panel">
                                    <div class="chart-header">
                                        <div><div class="chart-title"><i class="fas fa-arrow-right"></i> σ<sub>x</sub></div><div class="chart-subtitle">Longitudinal Contact Stress</div></div>
                                    </div>
                                    <div class="chart-body" id="chart-3d-ssx-sm"></div>
                                </div>
                                <div class="chart-panel">
                                    <div class="chart-header">
                                        <div><div class="chart-title"><i class="fas fa-arrows-left-right"></i> σ<sub>y</sub></div><div class="chart-subtitle">Transverse Contact Stress</div></div>
                                    </div>
                                    <div class="chart-body" id="chart-3d-ssy-sm"></div>
                                </div>
                            </div>
                        </div>
                        <div id="surface-ssz" style="display:none;">
                            <div class="chart-panel"><div class="chart-header"><div><div class="chart-title"><i class="fas fa-arrow-down"></i> Vertical Contact Stress (σ<sub>z</sub>)</div><div class="chart-subtitle" id="ssz-subtitle"></div></div></div><div class="chart-body chart-body-tall" id="chart-3d-ssz"></div></div>
                        </div>
                        <div id="surface-ssx" style="display:none;">
                            <div class="chart-panel"><div class="chart-header"><div><div class="chart-title"><i class="fas fa-arrow-right"></i> Longitudinal Contact Stress (σ<sub>x</sub>)</div><div class="chart-subtitle" id="ssx-subtitle"></div></div></div><div class="chart-body chart-body-tall" id="chart-3d-ssx"></div></div>
                        </div>
                        <div id="surface-ssy" style="display:none;">
                            <div class="chart-panel"><div class="chart-header"><div><div class="chart-title"><i class="fas fa-arrows-left-right"></i> Transverse Contact Stress (σ<sub>y</sub>)</div><div class="chart-subtitle" id="ssy-subtitle"></div></div></div><div class="chart-body chart-body-tall" id="chart-3d-ssy"></div></div>
                        </div>
                    </div>
                </div>

                <!-- ============================================= -->
                <!-- TAB 3: DISTRIBUTION ANALYSIS                  -->
                <!-- ============================================= -->
                <div class="module-content" id="module-analysis">
                    <div id="analysis-empty" class="empty-state">
                        <i class="fas fa-chart-area"></i>
                        <p><strong>No Data Yet</strong></p>
                        <p>Select an aircraft and compute stresses first.</p>
                    </div>
                    <div id="analysis-content" style="display:none;">
                        <div class="viz-tabs">
                            <button class="viz-tab active" data-viz="combined"><i class="fas fa-layer-group"></i> Combined</button>
                            <button class="viz-tab" data-viz="heatmaps"><i class="fas fa-th"></i> Heatmaps</button>
                            <button class="viz-tab" data-viz="ribcurves"><i class="fas fa-chart-line"></i> Per-Rib Curves</button>
                            <button class="viz-tab" data-viz="ribprops"><i class="fas fa-chart-bar"></i> Rib Properties</button>
                        </div>
                        <!-- Combined Stress Comparison -->
                        <div class="viz-content active" id="viz-combined">
                            <div class="charts-row two-col">
                                <div class="chart-panel">
                                    <div class="chart-header"><div><div class="chart-title"><i class="fas fa-layer-group"></i> All Stresses — Rib 1</div><div class="chart-subtitle">σz, σx, σy overlay</div></div></div>
                                    <div class="chart-body" id="chart-combined-rib1"></div>
                                </div>
                                <div class="chart-panel">
                                    <div class="chart-header"><div><div class="chart-title"><i class="fas fa-chart-bar"></i> Peak Stresses per Rib</div><div class="chart-subtitle">Max |σz|, |σx|, |σy|</div></div></div>
                                    <div class="chart-body" id="chart-peak-comparison"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Heatmaps -->
                        <div class="viz-content" id="viz-heatmaps">
                            <div class="charts-row three-col">
                                <div class="chart-panel"><div class="chart-header"><div class="chart-title"><i class="fas fa-th"></i> σ<sub>z</sub> Heatmap</div></div><div class="chart-body chart-body-short" id="chart-hm-ssz"></div></div>
                                <div class="chart-panel"><div class="chart-header"><div class="chart-title"><i class="fas fa-th"></i> σ<sub>x</sub> Heatmap</div></div><div class="chart-body chart-body-short" id="chart-hm-ssx"></div></div>
                                <div class="chart-panel"><div class="chart-header"><div class="chart-title"><i class="fas fa-th"></i> σ<sub>y</sub> Heatmap</div></div><div class="chart-body chart-body-short" id="chart-hm-ssy"></div></div>
                            </div>
                        </div>
                        <!-- Per-Rib Curves -->
                        <div class="viz-content" id="viz-ribcurves">
                            <div class="charts-row three-col">
                                <div class="chart-panel"><div class="chart-header"><div><div class="chart-title"><i class="fas fa-chart-line"></i> σ<sub>z</sub></div><div class="chart-subtitle">Per-Rib Distribution</div></div></div><div class="chart-body" id="chart-rib-ssz"></div></div>
                                <div class="chart-panel"><div class="chart-header"><div><div class="chart-title"><i class="fas fa-chart-line"></i> σ<sub>x</sub></div><div class="chart-subtitle">Per-Rib Distribution</div></div></div><div class="chart-body" id="chart-rib-ssx"></div></div>
                                <div class="chart-panel"><div class="chart-header"><div><div class="chart-title"><i class="fas fa-chart-line"></i> σ<sub>y</sub></div><div class="chart-subtitle">Per-Rib Distribution</div></div></div><div class="chart-body" id="chart-rib-ssy"></div></div>
                            </div>
                        </div>
                        <!-- Rib Properties -->
                        <div class="viz-content" id="viz-ribprops">
                            <div class="charts-row three-col">
                                <div class="chart-panel"><div class="chart-header"><div class="chart-title"><i class="fas fa-chart-bar"></i> Load Factor</div></div><div class="chart-body chart-body-short" id="chart-bar-load"></div></div>
                                <div class="chart-panel"><div class="chart-header"><div class="chart-title"><i class="fas fa-chart-bar"></i> Stress Factor</div></div><div class="chart-body chart-body-short" id="chart-bar-stress"></div></div>
                                <div class="chart-panel"><div class="chart-header"><div class="chart-title"><i class="fas fa-chart-bar"></i> Contact Width</div></div><div class="chart-body chart-body-short" id="chart-bar-width"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================= -->
                <!-- TAB 4: RESULTS SUMMARY                        -->
                <!-- ============================================= -->
                <div class="module-content" id="module-summary">
                    <div id="summary-empty" class="empty-state">
                        <i class="fas fa-table-list"></i>
                        <p><strong>No Results Yet</strong></p>
                        <p>Compute stresses to see the full results table.</p>
                    </div>
                    <div id="summary-content" style="display:none;">
                        <div style="display:flex; justify-content:flex-end; margin-bottom:0.6rem;">
                            <button class="btn btn-primary" id="btn-export-xlsx" style="font-size:0.88rem; padding:0.5rem 1.1rem;">
                                <i class="fas fa-file-excel"></i> Export to Excel
                            </button>
                        </div>
                        <div class="charts-row two-col">
                            <div class="panel">
                                <div class="panel-title"><i class="fas fa-table"></i> Stress Distribution Matrix</div>
                                <div id="summary-matrix-body"></div>
                            </div>
                            <div class="panel">
                                <div class="panel-title"><i class="fas fa-scale-balanced"></i> Equilibrium Verification</div>
                                <div id="summary-eq-body"></div>
                                <div class="chart-body chart-body-short" id="chart-eq-bar" style="margin-top:0.5rem;"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </section>
        <div id="footer-placeholder"></div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-card">
            <div class="spinner" id="loading-spinner"></div>
            <div class="progress-container" id="progress-container" style="display:none;">
                <div class="progress-bar-track"><div class="progress-bar-fill" id="progress-bar-fill"></div></div>
                <div class="progress-pct" id="progress-pct">0%</div>
            </div>
            <div class="loading-text" id="loading-text">Loading aircraft database...</div>
        </div>
    </div>

    <!-- ===== EXTERNAL SCRIPTS ===== -->
    <script src="../../assets/js/jquery.min.js"></script>
    <script src="../../assets/js/jquery.dropotron.min.js"></script>
    <script src="../../assets/js/browser.min.js"></script>
    <script src="../../assets/js/breakpoints.min.js"></script>
    <script src="../../assets/js/util.js"></script>
    <script src="../../assets/js/main.js"></script>
    <script src="../../assets/js/components.js"></script>
    <script src="../../assets/js/theme-toggle.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

    <script>
    // ================================================================
    //  AIRCRAFTER v2 — Contact Stress Analysis Engine
    // ================================================================

    let aircraftDB = [];
    let currentRow = null;
    let defaultParams = null;
    let results = null;

    const COLORS = ['#0ea5e9','#f97316','#10b981','#8b5cf6','#ef4444','#06b6d4','#f59e0b','#ec4899'];

    // ==================== MANUFACTURER MAPPING ====================
    function guessManufacturer(name) {
        const n = name.toUpperCase();
        if (/\bA3[0-9]{2}\b/.test(n) || /\bA2[0-9]{2}\b/.test(n)) return 'Airbus';
        if (/\bB7[0-9]{2}\b/.test(n) || /\bB73[0-9]\b/.test(n) || /\bB78[0-9]\b/.test(n) || /\b747|757|767|727|717|707/.test(n)) return 'Boeing';
        if (/\bMD[\-]?[0-9]/.test(n)) return 'McDonnell Douglas';
        if (/\bDC[\-]?[0-9]/.test(n)) return 'Douglas';
        if (/\bCRJ/.test(n) || /\bCS[0-9]/.test(n)) return 'Bombardier';
        if (/\bERJ|E1[0-9]{2}|E2[0-9]{2}/.test(n)) return 'Embraer';
        if (/\bATR/.test(n)) return 'ATR';
        if (/\bF[0-9]{2,3}\b/.test(n) && !/\bFA/.test(n)) return 'Fokker';
        if (/\bQ[0-9]{3}/.test(n)) return 'De Havilland';
        if (/\bC[\-]?1[0-9]{2}/.test(n)) return 'Lockheed';
        return 'Other';
    }

    // ==================== DATA LOADING ====================
    async function loadDatabase() {
        showLoading('Loading aircraft database...');
        try {
            const resp = await fetch('./aircraft.xlsx');
            if (!resp.ok) throw new Error('Failed to load aircraft.xlsx');
            const buf = await resp.arrayBuffer();
            const wb = XLSX.read(buf, { type: 'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const raw = XLSX.utils.sheet_to_json(ws, { defval: '' });

            aircraftDB = raw.map(r => ({
                name: String(r['Airplane Name'] || '').trim(),
                P: parseFloat(r['Load (N)']) || 0,
                TiP: parseFloat(r['Tire Pressure (MPa)']) || 0,
                l: parseFloat(r['Tire Contact Length (mm)']) || 0,
                bi_raw: String(r['Ribs (mm)'] || ''),
                al_raw: String(r['Load Factor'] || ''),
                sig_raw: String(r['Stress Factor'] || ''),
                manufacturer: guessManufacturer(String(r['Airplane Name'] || ''))
            }));

            document.getElementById('db-count').textContent = aircraftDB.length;
            populateFilters();
            hideLoading();
        } catch (err) {
            hideLoading();
            console.error(err);
            alert('Error loading database:\n' + err.message);
        }
    }

    function parseList(s) {
        return String(s).split(';').map(x => x.trim()).filter(x => x !== '').map(Number);
    }

    // ==================== FILTERS ====================
    function populateFilters() {
        const mfrs = [...new Set(aircraftDB.map(a => a.manufacturer))].sort();
        const mfrSelect = document.getElementById('filter-manufacturer');
        mfrSelect.innerHTML = '<option value="all">All Manufacturers</option>';
        mfrs.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m; opt.textContent = m + ' (' + aircraftDB.filter(a => a.manufacturer === m).length + ')';
            mfrSelect.appendChild(opt);
        });
        updateAircraftDropdown();
    }

    function updateAircraftDropdown() {
        const mfr = document.getElementById('filter-manufacturer').value;
        const search = document.getElementById('aircraft-search').value.toLowerCase();
        const acSelect = document.getElementById('filter-aircraft');

        let list = aircraftDB;
        if (mfr !== 'all') list = list.filter(a => a.manufacturer === mfr);
        if (search) list = list.filter(a => a.name.toLowerCase().includes(search));

        acSelect.innerHTML = '<option value="">— Select Aircraft (' + list.length + ') —</option>';
        list.forEach(a => {
            const opt = document.createElement('option');
            opt.value = a.name; opt.textContent = a.name;
            acSelect.appendChild(opt);
        });
    }

    // ==================== AIRCRAFT SELECTION ====================
    function onAircraftSelect() {
        const name = document.getElementById('filter-aircraft').value;
        if (!name) return;
        currentRow = aircraftDB.find(a => a.name === name);
        if (!currentRow) return;

        // Show modern selection loading overlay
        showSelectionLoading(currentRow.name);

        const bi = parseList(currentRow.bi_raw);
        const al = parseList(currentRow.al_raw);
        const sig = parseList(currentRow.sig_raw);

        defaultParams = {
            P: currentRow.P,
            TiP: Math.round(currentRow.TiP * 1000) / 1000,
            l: currentRow.l,
            bi: [...bi], al: [...al], sigm_Tip: [...sig]
        };

        // Stage the loading steps with brief delays for visual feedback
        setTimeout(() => {
            updateSelectionStep(0);
            applyParams(defaultParams);
            document.getElementById('param-panel').style.display = '';
            document.getElementById('stats-panel').style.display = '';
            document.getElementById('patch-panel').style.display = '';
            updateSummaryCards();
        }, 350);

        setTimeout(() => {
            updateSelectionStep(1);
            drawContactPatch();
        }, 700);

        setTimeout(() => {
            updateSelectionStep(2);
            try {
                results = computeStresses();
                updateEquilibriumBadge();
                updateSummaryCards();
                Object.keys(chartsNeedRerender).forEach(k => chartsNeedRerender[k] = true);
                renderChartsForModule(getActiveModule());
                ['stress3d-empty','analysis-empty','summary-empty'].forEach(id =>
                    document.getElementById(id).style.display = 'none');
                ['stress3d-content','analysis-content','summary-content'].forEach(id =>
                    document.getElementById(id).style.display = '');
            } catch (e) {
                console.error('Compute error:', e);
            }
            hideSelectionLoading();
            showSuccessFlash();
        }, 1100);
    }

    function applyParams(p) {
        document.getElementById('input-P').value = p.P;
        document.getElementById('input-TiP').value = p.TiP;
        document.getElementById('input-l').value = p.l;
        buildRibTable(p.bi, p.al, p.sigm_Tip);
        clearModifiedFlags();
    }

    function getCurrentParams() {
        const P = parseFloat(document.getElementById('input-P').value) || 0;
        const TiP = parseFloat(document.getElementById('input-TiP').value) || 0;
        const l = parseFloat(document.getElementById('input-l').value) || 0;
        const bi = [], al = [], sigm_Tip = [];
        document.querySelectorAll('#rib-table .rib-bi').forEach(inp => bi.push(parseFloat(inp.value) || 0));
        document.querySelectorAll('#rib-table .rib-al').forEach(inp => al.push(parseFloat(inp.value) || 0));
        document.querySelectorAll('#rib-table .rib-sig').forEach(inp => sigm_Tip.push(parseFloat(inp.value) || 0));
        return { P, TiP, l, bi, al, sigm_Tip };
    }

    function getAdvancedParams() {
        const pf = (id, def) => { const v = parseFloat(document.getElementById(id).value); return isNaN(v) ? def : v; };
        return {
            ssy_factor: pf('adv-ssy', 0.40),
            xn: parseInt(document.getElementById('adv-xn').value) || 10,
            nnz: parseInt(document.getElementById('adv-nnz').value) || 2,
            lsx_pospk: pf('adv-lsx-pos', 0.20),
            lsx_negpk: pf('adv-lsx-neg', 0.85),
            sx_posmag: pf('adv-sx-posmag', 0.20),
            sx_negmag: pf('adv-sx-negmag', -0.15),
            skpb: pf('adv-skpb', 0.60),
        };
    }

    // ==================== RIB TABLE ====================
    function buildRibTable(bi, al, sig) {
        const numRibs = bi.length;
        const thead = document.getElementById('rib-table-header');
        const tbody = document.getElementById('rib-table-body');
        let hdr = '<th>Parameter</th>';
        for (let i = 0; i < numRibs; i++) hdr += `<th>Rib ${i + 1}</th>`;
        thead.innerHTML = hdr;
        const rows = [
            { label: 'b<sub>i</sub> [mm]', cls: 'rib-bi', vals: bi },
            { label: 'α<sub>l</sub>', cls: 'rib-al', vals: al },
            { label: 'σ<sub>Tip</sub> [MPa]', cls: 'rib-sig', vals: sig }
        ];
        tbody.innerHTML = '';
        rows.forEach(r => {
            let tr = `<td class="rib-header-cell">${r.label}</td>`;
            r.vals.forEach(v => { tr += `<td><input type="number" class="${r.cls}" value="${v}" step="any" /></td>`; });
            const trEl = document.createElement('tr');
            trEl.innerHTML = tr;
            tbody.appendChild(trEl);
        });
    }

    function clearModifiedFlags() {
        document.querySelectorAll('.param-card').forEach(c => c.classList.remove('modified'));
        document.querySelectorAll('.rib-table td input').forEach(i => i.classList.remove('modified'));
    }

    function checkModified() {
        if (!defaultParams) return;
        const cur = getCurrentParams();
        ['P', 'TiP', 'l'].forEach(k => {
            const card = document.getElementById('card-' + k);
            if (Math.abs(cur[k] - defaultParams[k]) > 1e-9) card.classList.add('modified');
            else card.classList.remove('modified');
        });
        document.querySelectorAll('.rib-bi').forEach((inp, i) => {
            inp.classList.toggle('modified', Math.abs(parseFloat(inp.value) - defaultParams.bi[i]) > 1e-9);
        });
        document.querySelectorAll('.rib-al').forEach((inp, i) => {
            inp.classList.toggle('modified', Math.abs(parseFloat(inp.value) - defaultParams.al[i]) > 1e-9);
        });
        document.querySelectorAll('.rib-sig').forEach((inp, i) => {
            inp.classList.toggle('modified', Math.abs(parseFloat(inp.value) - defaultParams.sigm_Tip[i]) > 1e-9);
        });
    }

    // ==================== SUMMARY ====================
    function updateSummaryCards() {
        if (!currentRow) return;
        const p = getCurrentParams();
        document.getElementById('stat-aircraft').textContent = currentRow.name.replace(/^ICT-/, '');
        document.getElementById('stat-load').textContent = (p.P / 1000).toFixed(1);
        document.getElementById('stat-pressure').textContent = p.TiP.toFixed(3) + ' MPa';
        document.getElementById('stat-length').textContent = p.l.toFixed(1);
        document.getElementById('stat-ribs').textContent = p.bi.length;
    }

    function updateEquilibriumBadge() {
        if (!results) return;
        const el = document.getElementById('eq-stat');
        const pct = Math.abs(results.diff).toFixed(2);
        const icon = results.eqPassed ? 'check-circle' : 'times-circle';
        const cls = results.eqPassed ? 'eq-pass' : 'eq-fail';
        el.className = 'mini-stat ' + cls;
        document.getElementById('stat-eq').innerHTML = `<i class="fas fa-${icon}"></i> ${pct}%`;
    }

    // ==================== CONTACT PATCH SVG ====================
    function drawContactPatch() {
        const p = getCurrentParams();
        if (!p.bi.length) return;
        const svg = document.getElementById('contact-patch-svg');
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const textCol = isDark ? '#e2e8f0' : '#1e293b';
        const lineCol = isDark ? '#546a84' : '#6b7b8d';
        const dimCol = isDark ? '#a8b8cc' : '#506070';
        const bgCol = isDark ? 'rgba(15,23,42,0.8)' : 'rgba(255,255,255,0.95)';
        const ribColors = [
            [14, 165, 233], [249, 115, 22], [16, 185, 129], [139, 92, 246],
            [239, 68, 68], [6, 182, 212], [245, 158, 11], [236, 72, 153]
        ];

        const totalW = p.bi.reduce((s, v) => s + v, 0);
        const pad = 80; const patchW = 480; const patchH = 240;
        const scaleY = patchH / totalW;
        const ox = pad; const oy = pad - 10;
        const svgW = ox + patchW + 140;
        const svgH = oy + patchH + 65;
        svg.setAttribute('viewBox', `0 0 ${svgW} ${svgH}`);

        let defs = '<defs>';
        // Gradient defs per rib
        const maxAl = Math.max(...p.al);
        p.bi.forEach((_, i) => {
            const c = ribColors[i % ribColors.length];
            const alpha = 0.18 + 0.5 * (p.al[i] / (maxAl || 1));
            defs += `<linearGradient id="ribGrad${i}" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="rgba(${c.join(',')},${(alpha * 0.5).toFixed(2)})"/>
                <stop offset="50%" stop-color="rgba(${c.join(',')},${alpha.toFixed(2)})"/>
                <stop offset="100%" stop-color="rgba(${c.join(',')},${(alpha * 0.5).toFixed(2)})"/>
            </linearGradient>`;
        });
        // Arrow markers
        defs += `
            <marker id="arrowR" markerWidth="8" markerHeight="8" refX="7" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8" fill="${dimCol}"/></marker>
            <marker id="arrowL" markerWidth="8" markerHeight="8" refX="1" refY="4" orient="auto"><path d="M8,0 L0,4 L8,8" fill="${dimCol}"/></marker>
            <marker id="arrowD" markerWidth="8" markerHeight="8" refX="4" refY="7" orient="auto"><path d="M0,0 L4,8 L8,0" fill="${dimCol}"/></marker>
            <marker id="arrowU" markerWidth="8" markerHeight="8" refX="4" refY="1" orient="auto"><path d="M0,8 L4,0 L8,8" fill="${dimCol}"/></marker>
        </defs>`;

        let html = '';
        // Title
        html += `<text x="${ox + patchW / 2}" y="${oy - 22}" text-anchor="middle" font-size="18" fill="${textCol}" font-weight="700" letter-spacing="0.5">Tire Contact Footprint</text>`;
        // Outer patch border
        html += `<rect x="${ox}" y="${oy}" width="${patchW}" height="${patchH}" rx="10" ry="10" fill="none" stroke="${lineCol}" stroke-width="1.5" stroke-dasharray="6 4"/>`;

        // Rib rectangles with gradient fills
        let cumY = 0;
        p.bi.forEach((w, i) => {
            const rh = w * scaleY;
            const c = ribColors[i % ribColors.length];
            html += `<rect x="${ox}" y="${oy + cumY}" width="${patchW}" height="${rh}" fill="url(#ribGrad${i})" stroke="rgba(${c.join(',')},0.4)" stroke-width="1"/>`;
            // Rib labels (right side) — name and width on same line
            const labelY = oy + cumY + rh / 2 + 5;
            html += `<text x="${ox + patchW + 14}" y="${labelY}" font-size="15" fill="${textCol}" font-weight="700" dominant-baseline="auto">Rib ${i + 1} <tspan fill="rgba(${c.join(',')},0.9)" font-size="13" font-weight="600"> · ${w.toFixed(1)} mm</tspan></text>`;
            // Width dimension tick marks
            if (rh > 12) {
                html += `<line x1="${ox - 6}" y1="${oy + cumY}" x2="${ox}" y2="${oy + cumY}" stroke="${dimCol}" stroke-width="0.8"/>`;
            }
            cumY += rh;
        });
        html += `<line x1="${ox - 6}" y1="${oy + patchH}" x2="${ox}" y2="${oy + patchH}" stroke="${dimCol}" stroke-width="0.8"/>`;

        // Horizontal dimension arrow (contact length)
        const ay = oy + patchH + 35;
        html += `<line x1="${ox}" y1="${ay}" x2="${ox + patchW}" y2="${ay}" stroke="${dimCol}" stroke-width="1.5" marker-start="url(#arrowL)" marker-end="url(#arrowR)"/>`;
        html += `<rect x="${ox + patchW / 2 - 52}" y="${ay + 4}" width="104" height="24" rx="6" fill="${bgCol}" stroke="${lineCol}" stroke-width="0.5"/>`;
        html += `<text x="${ox + patchW / 2}" y="${ay + 21}" text-anchor="middle" font-size="15" fill="${textCol}" font-weight="700">l = ${p.l.toFixed(2)} mm</text>`;

        // Vertical dimension arrow (total width)
        const ax = ox - 32;
        html += `<line x1="${ax}" y1="${oy}" x2="${ax}" y2="${oy + patchH}" stroke="${dimCol}" stroke-width="1.5" marker-start="url(#arrowU)" marker-end="url(#arrowD)"/>`;
        html += `<text x="${ax - 6}" y="${oy + patchH / 2}" text-anchor="middle" font-size="15" fill="${textCol}" font-weight="700" transform="rotate(-90 ${ax - 6} ${oy + patchH / 2})">W = ${totalW.toFixed(1)} mm</text>`;

        svg.innerHTML = defs + html;
    }

    // ================================================================
    //  STRESS CALCULATIONS
    // ================================================================
    function computeStresses() {
        const p = getCurrentParams();
        const adv = getAdvancedParams();
        const { P, TiP, l, bi, al, sigm_Tip } = p;
        const { ssy_factor, xn, nnz, lsx_pospk, lsx_negpk, sx_posmag, sx_negmag, skpb } = adv;
        const numRibs = bi.length;
        const l_elem = l / xn;

        const xloc = [], xnorm = [], xdist = [];
        for (let i = 0; i <= xn; i++) {
            xdist.push(l_elem * i);
            xloc.push(l_elem * i - l / 2);
            xnorm.push((l_elem * i - l / 2) / (l / 2));
        }

        const ssx_idx = Math.min(Math.round(skpb * xdist.length), xdist.length - 1);
        const ssx_cut = ssx_idx >= 0 ? xdist[ssx_idx] : (skpb * l);

        // 1. VERTICAL (SSZ) — Generalized parabola
        const SSZ = {};
        for (let i = 0; i < numRibs; i++) {
            const a = al[i], b = bi[i], s = sigm_Tip[i];
            const denom = (l * b * s * TiP) / (a * P) - 1.0;
            const n = Math.abs(1.0 / (2.0 * denom));
            const coeff = (a * P) / (l * b);
            const factor = 1.0 + 1.0 / (2.0 * n);
            SSZ['Rib ' + (i + 1)] = xnorm.map(x => coeff * factor * (1 - Math.pow(x * x, n)));
        }

        // 2. LONGITUDINAL (SSX) — Skewed rational parabola
        const SSX = {};
        const x1 = [0, skpb * l], x2 = [lsx_pospk * l, lsx_negpk * l];
        const x3 = [skpb * l, l], y2 = [sx_posmag, sx_negmag];
        const a3 = [0, 1].map(k => (x1[k] + x3[k] - 2 * x2[k]) / (x1[k] * x3[k] - x2[k] * x2[k]));
        const a0 = [0, 1].map(k => (-x1[k] * x3[k] * (a3[k] * x2[k] - 1) * y2[k]) / ((x1[k] - x2[k]) * (x3[k] - x2[k])));
        const a1 = [0, 1].map(k => ((x1[k] + x3[k]) * (a3[k] * x2[k] - 1) * y2[k]) / ((x1[k] - x2[k]) * (x3[k] - x2[k])));
        const a2 = [0, 1].map(k => (y2[k] - a3[k] * x2[k] * y2[k]) / ((x1[k] - x2[k]) * (x3[k] - x2[k])));

        for (let i = 0; i < numRibs; i++) {
            const s = sigm_Tip[i];
            SSX['Rib ' + (i + 1)] = xdist.map(x => {
                const k = (x >= 0 && x <= ssx_cut) ? 0 : 1;
                return TiP * s * ((a2[k] * x * x + a1[k] * x + a0[k]) / (1 - a3[k] * x));
            });
        }

        // 3. TRANSVERSE (SSY)
        const SSY = {};
        for (let i = 0; i < numRibs; i++)
            SSY['Rib ' + (i + 1)] = SSZ['Rib ' + (i + 1)].map(v => ssy_factor * v);

        // 4. AVERAGED VALUES
        const axdist = [];
        for (let j = 0; j < xn; j++) axdist.push((xdist[j] + xdist[j + 1]) / 2);

        const asz = {}, asx = {}, asy = {};
        for (let i = 0; i < numRibs; i++) {
            const key = 'Rib ' + (i + 1);
            asz[key] = []; asx[key] = []; asy[key] = [];
            for (let j = 0; j < xn; j++) {
                asz[key].push((SSZ[key][j] + SSZ[key][j + 1]) / 2);
                asx[key].push((SSX[key][j] + SSX[key][j + 1]) / 2);
                asy[key].push((SSY[key][j] + SSY[key][j + 1]) / 2);
            }
        }

        // 5. EQUILIBRIUM CHECK
        let Calc_Pz = 0;
        const eqPerRib = [];
        for (let i = 0; i < numRibs; i++) {
            const key = 'Rib ' + (i + 1);
            const sumSz = asz[key].reduce((s, v) => s + v, 0);
            const eq = sumSz * l_elem * bi[i];
            eqPerRib.push(eq);
            Calc_Pz += eq;
        }
        const diff = 100 * (P - Calc_Pz) / P;
        const eqPassed = Math.abs(diff) <= 2.5;

        const sszMat = [], ssxMat = [], ssyMat = [];
        for (let i = 0; i < numRibs; i++) {
            const key = 'Rib ' + (i + 1);
            sszMat.push(asz[key]); ssxMat.push(asx[key]); ssyMat.push(asy[key]);
        }

        return {
            numRibs, bi, al, sigm_Tip, P, TiP, l, xn, l_elem,
            xdist, xloc, xnorm, axdist,
            SSZ, SSX, SSY, asz, asx, asy,
            sszMat, ssxMat, ssyMat,
            Calc_Pz, diff, eqPassed, eqPerRib,
            nz: new Array(numRibs).fill(nnz)
        };
    }

    // ================================================================
    //  PLOTLY THEME & CONFIG
    // ================================================================
    function getPlotlyTheme() {
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        return {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: isDark ? 'rgba(30,41,59,0.5)' : 'rgba(233,239,245,0.6)',
            font: { color: isDark ? '#f1f5f9' : '#0f172a', family: 'Source Sans Pro, sans-serif', size: isMobile() ? 11 : 14 },
            scene: {
                bgcolor: 'rgba(0,0,0,0)',
                xaxis: { color: isDark ? '#c8d5e3' : '#374151', gridcolor: isDark ? '#3b4f6b' : '#c0ccd8', showbackground: true, backgroundcolor: isDark ? 'rgba(15,23,42,0.3)' : 'rgba(233,239,245,0.5)' },
                yaxis: { color: isDark ? '#c8d5e3' : '#374151', gridcolor: isDark ? '#3b4f6b' : '#c0ccd8', showbackground: true, backgroundcolor: isDark ? 'rgba(15,23,42,0.3)' : 'rgba(233,239,245,0.5)' },
                zaxis: { color: isDark ? '#c8d5e3' : '#374151', gridcolor: isDark ? '#3b4f6b' : '#c0ccd8', showbackground: true, backgroundcolor: isDark ? 'rgba(15,23,42,0.3)' : 'rgba(233,239,245,0.5)' },
            },
            xaxis: { gridcolor: isDark ? '#3b4f6b' : '#c0ccd8', zerolinecolor: isDark ? '#546a84' : '#8896a4', linecolor: isDark ? '#546a84' : '#8896a4', mirror: true, ticks: 'outside', showline: true },
            yaxis: { gridcolor: isDark ? '#3b4f6b' : '#c0ccd8', zerolinecolor: isDark ? '#546a84' : '#8896a4', linecolor: isDark ? '#546a84' : '#8896a4', mirror: true, ticks: 'outside', showline: true },
            colorway: COLORS,
            hoverlabel: { font: { color: isDark ? '#0f172a' : '#0f172a', size: 13 }, bgcolor: isDark ? '#f1f5f9' : '#ffffff', bordercolor: isDark ? '#546a84' : '#8896a4' },
            margin: mobileMargin({ l: 55, r: 25, t: 35, b: 50 }),
        };
    }
    const plotlyConfig = { responsive: true, displayModeBar: true, displaylogo: false,
        modeBarButtonsToRemove: ['toImage', 'sendDataToCloud'] };

    function isMobile() { return window.innerWidth <= 768; }
    function mobileMargin(desktop) {
        if (!isMobile()) return desktop;
        return { l: Math.min(desktop.l, 40), r: Math.min(desktop.r, 15), t: Math.min(desktop.t, 25), b: Math.min(desktop.b, 45) };
    }
    function mobileFontSize(desktop) { return isMobile() ? Math.max(desktop - 2, 10) : desktop; }

    // ================================================================
    //  RENDERING — ENHANCED PLOTLY CHARTS
    // ================================================================

    function render3DSurface(containerId, matrix, axdist, ribCenters, ribLabels, opts) {
        const theme = getPlotlyTheme();
        const { title, colorscale, symmetric, compact } = opts;
        const flat = matrix.flat();
        let cmin, cmax;
        if (symmetric) { const vm = Math.max(...flat.map(Math.abs)); cmin = -vm; cmax = vm; }
        else { cmin = Math.min(...flat); cmax = Math.max(...flat); }

        const surface = {
            type: 'surface', x: axdist, y: ribCenters, z: matrix,
            colorscale, cmin, cmax, showscale: !compact,
            colorbar: compact ? {} : { title: { text: title + ' [MPa]', font: { size: 11, color: theme.font.color } }, tickfont: { color: theme.font.color }, thickness: 14, len: 0.65 },
            contours: {
                z: { show: true, usecolormap: true, highlightcolor: '#fff', project: { z: true }, size: (cmax - cmin) / 30 },
                x: { show: true, usecolormap: true, highlightwidth: 0.5, size: (axdist[axdist.length - 1] - axdist[0]) / 15 },
                y: { show: true, usecolormap: true, highlightwidth: 0.5, size: (ribCenters[ribCenters.length - 1] - ribCenters[0]) / (ribCenters.length * 2 || 1) }
            },
            lighting: { ambient: 0.55, diffuse: 0.5, specular: 0.2, roughness: 0.4, fresnel: 0.3 },
            hovertemplate: 'x: %{x:.1f} mm<br>y: %{y:.1f} mm<br>σ: %{z:.4f} MPa<extra></extra>'
        };

        const m = compact ? { l: 0, r: 0, t: 10, b: 0 } : { l: 0, r: 0, t: 25, b: 0 };
        const layout = {
            ...theme,
            scene: {
                ...theme.scene,
                xaxis: { ...theme.scene.xaxis, title: compact ? '' : 'Contact Length [mm]' },
                yaxis: { ...theme.scene.yaxis, title: compact ? '' : 'Width [mm]' },
                zaxis: { ...theme.scene.zaxis, title: compact ? '' : (title + ' [MPa]') },
                camera: { eye: { x: 1.5, y: -1.5, z: 0.9 } },
                aspectratio: { x: 1.4, y: 1, z: 0.7 }
            },
            title: compact ? '' : { text: opts.fullTitle || '', font: { size: 13 } },
            margin: m
        };
        Plotly.newPlot(containerId, [surface], layout, plotlyConfig);
    }

    function renderHeatmap(containerId, matrix, axdist, ribLabels, opts) {
        const theme = getPlotlyTheme();
        const { title, colorscale, symmetric } = opts;
        const flat = matrix.flat();
        let zmin, zmax, zmid;
        if (symmetric) { const vm = Math.max(...flat.map(Math.abs)); zmin = -vm; zmax = vm; zmid = 0; }
        else { zmin = Math.min(...flat); zmax = Math.max(...flat); }

        // Add value annotations
        const annotations = [];
        matrix.forEach((row, ri) => {
            row.forEach((val, ci) => {
                annotations.push({
                    x: axdist[ci], y: ribLabels[ri], text: val.toFixed(3),
                    showarrow: false, font: { size: 9, color: Math.abs(val) > (zmax - zmin) * 0.6 + zmin ? 'white' : theme.font.color }
                });
            });
        });

        const trace = {
            type: 'heatmap', x: axdist, y: ribLabels, z: matrix,
            colorscale, zmin, zmax, zmid, showscale: true,
            colorbar: { title: { text: title + ' [MPa]', font: { size: 10, color: theme.font.color } }, tickfont: { color: theme.font.color }, thickness: 12 },
            hovertemplate: 'x: %{x:.1f} mm<br>%{y}<br>σ: %{z:.4f} MPa<extra></extra>',
            xgap: 2, ygap: 2
        };
        const layout = {
            ...theme, annotations,
            xaxis: { ...theme.xaxis, title: 'Contact Length [mm]' },
            yaxis: { ...theme.yaxis, title: '', autorange: 'reversed' },
            margin: mobileMargin({ l: 90, r: 25, t: 20, b: 60 })
        };
        Plotly.newPlot(containerId, [trace], layout, plotlyConfig);
    }

    function renderRibCurves(containerId, theoryDict, avgDict, xTheory, axdist, ribLabels, opts) {
        const theme = getPlotlyTheme();
        const { title, symmetric } = opts;
        const numRibs = ribLabels.length;
        const traces = [];
        const dashes = ['solid', 'dash', 'dot', 'dashdot', 'longdash', 'longdashdot', 'solid'];

        // LAYER 1: Fill-only traces (very transparent, drawn first / behind)
        for (let i = 0; i < numRibs; i++) {
            const key = 'Rib ' + (i + 1);
            const col = COLORS[i % COLORS.length];
            traces.push({
                type: 'scatter', mode: 'none', x: xTheory, y: theoryDict[key],
                fill: 'tozeroy',
                fillcolor: col.replace(')', ',0.10)').replace('rgb', 'rgba'),
                legendgroup: key, showlegend: false, hoverinfo: 'skip'
            });
        }
        // LAYER 2: Line traces (no fill, drawn on top — always visible)
        for (let i = 0; i < numRibs; i++) {
            const key = 'Rib ' + (i + 1);
            const col = COLORS[i % COLORS.length];
            const dash = dashes[i % dashes.length];
            traces.push({
                type: 'scatter', mode: 'lines', x: xTheory, y: theoryDict[key],
                name: ribLabels[i], line: { color: col, width: 2.5, dash },
                legendgroup: key,
                hovertemplate: 'x: %{x:.1f}<br>σ: %{y:.4f} MPa<extra>' + ribLabels[i] + '</extra>'
            });
        }
        // LAYER 3: Averaged scatter markers (on top of everything)
        for (let i = 0; i < numRibs; i++) {
            const key = 'Rib ' + (i + 1);
            const col = COLORS[i % COLORS.length];
            traces.push({
                type: 'scatter', mode: 'lines+markers', x: axdist, y: avgDict[key],
                name: ribLabels[i] + ' avg', legendgroup: key, showlegend: false,
                line: { color: col, width: 1, dash: 'dot' },
                marker: { color: col, size: 5, symbol: 'diamond',
                    line: { color: 'rgba(255,255,255,0.6)', width: 0.8 } },
                hovertemplate: 'x: %{x:.1f}<br>σ<sub>avg</sub>: %{y:.4f} MPa<extra>' + ribLabels[i] + '</extra>'
            });
        }

        // Add peak annotations
        const annotations = [];
        for (let i = 0; i < numRibs; i++) {
            const key = 'Rib ' + (i + 1);
            const vals = theoryDict[key];
            const maxIdx = vals.indexOf(Math.max(...vals));
            if (i === 0) { // Only annotate first rib's peak to avoid clutter
                annotations.push({
                    x: xTheory[maxIdx], y: vals[maxIdx],
                    text: `Peak: ${vals[maxIdx].toFixed(3)}`,
                    showarrow: true, arrowhead: 2, arrowsize: 0.8,
                    ax: 0, ay: -28,
                    font: { size: 10, color: COLORS[i], weight: 'bold' },
                    bgcolor: theme.paper_bgcolor === 'rgba(0,0,0,0)' ? 'var(--ac-bg-panel)' : 'white',
                    bordercolor: COLORS[i], borderwidth: 1, borderpad: 3
                });
            }
        }

        const layout = {
            ...theme, annotations,
            xaxis: { ...theme.xaxis, title: 'Contact Length [mm]' },
            yaxis: { ...theme.yaxis, title: title + ' [MPa]' },
            legend: { orientation: 'h', y: -0.22, x: 0.5, xanchor: 'center', font: { size: 11 } },
            margin: mobileMargin({ l: 60, r: 15, t: 25, b: 80 }),
            hovermode: 'x unified'
        };

        if (symmetric) {
            const allY = traces.flatMap(t => t.y || []);
            const vmax = Math.max(...allY.map(Math.abs)) * 1.2;
            layout.yaxis.range = [-vmax, vmax];
            layout.shapes = [{ type: 'line', x0: 0, x1: 1, xref: 'paper', y0: 0, y1: 0,
                line: { color: 'rgba(100,100,100,0.4)', width: 1, dash: 'dash' } }];
        }
        Plotly.newPlot(containerId, traces, layout, plotlyConfig);
    }

    function renderBarChart(containerId, values, labels, opts) {
        const theme = getPlotlyTheme();
        const { title } = opts;
        const n = values.length;
        // Reverse so Rib 1 at top, highest rib at bottom (matching contact patch)
        const revValues = [...values].reverse();
        const revLabels = [...labels].reverse();

        // Use COLORS palette — each rib gets its own distinct color
        const barColors = revValues.map((_, i) => {
            const col = COLORS[(n - 1 - i) % COLORS.length];
            return col.replace('rgb', 'rgba').replace(')', ',0.65)');
        });
        const borderColors = revValues.map((_, i) => COLORS[(n - 1 - i) % COLORS.length]);

        const trace = {
            type: 'bar', orientation: 'h', x: revValues, y: revLabels,
            marker: { color: barColors, line: { color: borderColors, width: 1.5 } },
            text: revValues.map(v => v.toFixed(4)),
            textposition: 'outside', textfont: { size: mobileFontSize(11) },
            hovertemplate: '%{y}: %{x:.4f}<extra></extra>',
            cliponaxis: false
        };

        // Compute x-range with room for outside text
        const xMax = Math.max(...revValues) * 1.25;
        const layout = {
            ...theme,
            xaxis: { ...theme.xaxis, title, range: [0, xMax] },
            yaxis: { ...theme.yaxis, categoryorder: 'array', categoryarray: revLabels },
            margin: mobileMargin({ l: 65, r: 70, t: 15, b: 55 })
        };
        Plotly.newPlot(containerId, [trace], layout, plotlyConfig);
    }

    // ---- COMBINED STRESS OVERLAY ----
    function renderCombinedRib(containerId, r, ribIdx) {
        const theme = getPlotlyTheme();
        const key = 'Rib ' + (ribIdx + 1);
        const traces = [
            { type: 'scatter', mode: 'lines', x: r.xdist, y: r.SSZ[key], name: 'σz (Vertical)',
                line: { color: '#ef4444', width: 2.5 }, fill: 'tozeroy', fillcolor: 'rgba(239,68,68,0.08)',
                hovertemplate: 'σz: %{y:.4f} MPa<extra></extra>' },
            { type: 'scatter', mode: 'lines', x: r.xdist, y: r.SSX[key], name: 'σx (Longitudinal)',
                line: { color: '#0ea5e9', width: 2.5 }, fill: 'tozeroy', fillcolor: 'rgba(14,165,233,0.08)',
                hovertemplate: 'σx: %{y:.4f} MPa<extra></extra>' },
            { type: 'scatter', mode: 'lines', x: r.xdist, y: r.SSY[key], name: 'σy (Transverse)',
                line: { color: '#10b981', width: 2.5, dash: 'dash' }, fill: 'tozeroy', fillcolor: 'rgba(16,185,129,0.06)',
                hovertemplate: 'σy: %{y:.4f} MPa<extra></extra>' },
        ];
        const layout = {
            ...theme,
            xaxis: { ...theme.xaxis, title: 'Contact Length [mm]' },
            yaxis: { ...theme.yaxis, title: 'Stress [MPa]' },
            legend: { orientation: 'h', y: -0.22, x: 0.5, xanchor: 'center', font: { size: 11 } },
            margin: mobileMargin({ l: 60, r: 15, t: 15, b: 80 }), hovermode: 'x unified',
            shapes: [{ type: 'line', x0: 0, x1: 1, xref: 'paper', y0: 0, y1: 0,
                line: { color: 'rgba(100,100,100,0.35)', width: 1, dash: 'dash' } }]
        };
        Plotly.newPlot(containerId, traces, layout, plotlyConfig);
    }

    function renderPeakComparison(containerId, r) {
        const theme = getPlotlyTheme();
        // Reverse so Rib 1 at top, highest rib at bottom
        const ribNames = r.bi.map((_, i) => `Rib ${i + 1}`).reverse();
        const peakZ = [], peakX = [], peakY = [];
        for (let i = r.numRibs - 1; i >= 0; i--) {
            const key = 'Rib ' + (i + 1);
            peakZ.push(Math.max(...r.SSZ[key]));
            peakX.push(Math.max(...r.SSX[key].map(Math.abs)));
            peakY.push(Math.max(...r.SSY[key]));
        }
        const traces = [
            { type: 'bar', name: 'Max σz', y: ribNames, x: peakZ, orientation: 'h',
                marker: { color: 'rgba(239,68,68,0.7)', line: { color: '#ef4444', width: 1.5 } },
                text: peakZ.map(v => v.toFixed(3)), textposition: 'outside', textfont: { size: mobileFontSize(11) } },
            { type: 'bar', name: 'Max |σx|', y: ribNames, x: peakX, orientation: 'h',
                marker: { color: 'rgba(14,165,233,0.7)', line: { color: '#0ea5e9', width: 1.5 } },
                text: peakX.map(v => v.toFixed(3)), textposition: 'outside', textfont: { size: mobileFontSize(11) } },
            { type: 'bar', name: 'Max σy', y: ribNames, x: peakY, orientation: 'h',
                marker: { color: 'rgba(16,185,129,0.7)', line: { color: '#10b981', width: 1.5 } },
                text: peakY.map(v => v.toFixed(3)), textposition: 'outside', textfont: { size: mobileFontSize(11) } },
        ];
        const xMax = Math.max(...peakZ, ...peakX, ...peakY) * 1.2;
        const layout = {
            ...theme, barmode: 'group',
            xaxis: { ...theme.xaxis, title: 'Peak Stress [MPa]', range: [0, xMax] },
            yaxis: { ...theme.yaxis, categoryorder: 'array', categoryarray: ribNames },
            legend: { orientation: 'h', y: -0.18, x: 0.5, xanchor: 'center', font: { size: 13 } },
            margin: mobileMargin({ l: 65, r: 65, t: 15, b: 80 })
        };
        Plotly.newPlot(containerId, traces, layout, plotlyConfig);
    }

    function renderEqBar(containerId, r) {
        const theme = getPlotlyTheme();
        // Reverse so Rib 1 at top, highest rib at bottom
        const ribNames = r.bi.map((_, i) => `Rib ${i + 1}`).reverse();
        const revEq = [...r.eqPerRib].reverse();
        const trace = {
            type: 'bar', y: ribNames, x: revEq, orientation: 'h',
            marker: {
                color: revEq.map(v => v >= 0 ? 'rgba(16,185,129,0.6)' : 'rgba(239,68,68,0.6)'),
                line: { color: revEq.map(v => v >= 0 ? '#10b981' : '#ef4444'), width: 1 }
            },
            text: revEq.map(v => (v / 1000).toFixed(2) + ' kN'),
            textposition: 'outside', textfont: { size: mobileFontSize(11) },
            hovertemplate: '%{y}: %{x:.2f} N<extra></extra>'
        };
        // Add reference line at P/numRibs
        const idealLoad = r.P / r.numRibs;
        const layout = {
            ...theme,
            xaxis: { ...theme.xaxis, title: 'Load Contribution [N]' },
            yaxis: { ...theme.yaxis, categoryorder: 'array', categoryarray: ribNames },
            margin: mobileMargin({ l: 55, r: 55, t: 10, b: 40 }),
            shapes: [{ type: 'line', x0: idealLoad, x1: idealLoad, y0: -0.5, y1: r.numRibs - 0.5,
                line: { color: 'rgba(245,158,11,0.6)', width: 1.5, dash: 'dash' } }],
            annotations: [{ x: idealLoad, y: r.numRibs - 0.5, text: 'Ideal (' + (idealLoad / 1000).toFixed(1) + ' kN)',
                showarrow: false, yshift: 12, font: { size: 8, color: '#f59e0b' } }]
        };
        Plotly.newPlot(containerId, [trace], layout, plotlyConfig);
    }

    // ================================================================
    //  RENDER ALL CHARTS
    // ================================================================
    let chartsNeedRerender = { stress3d: true, analysis: true, summary: true, config: true };

    function getActiveModule() {
        const active = document.querySelector('.module-tab.active');
        return active ? active.dataset.module : 'config';
    }

    function renderChartsForModule(mod) {
        if (!results) return;
        const r = results;
        const ribLabels = r.bi.map((w, i) => `Rib ${i + 1} (${w} mm)`);
        const ribNames = r.bi.map((_, i) => `Rib ${i + 1}`);
        const cumW = [0];
        r.bi.forEach(w => cumW.push(cumW[cumW.length - 1] + w));
        const totalW = cumW[cumW.length - 1];
        const ribCenters = r.bi.map((w, i) => cumW[i] + w / 2 - totalW / 2);

        if (mod === 'config') {
            // Small 3D tiles (overview) + quick results
            render3DSurface('chart-3d-ssz-sm', r.sszMat, r.axdist, ribCenters, ribLabels,
                { title: 'σz', colorscale: 'YlOrRd', symmetric: false, compact: true });
            render3DSurface('chart-3d-ssx-sm', r.ssxMat, r.axdist, ribCenters, ribLabels,
                { title: 'σx', colorscale: 'RdBu', symmetric: true, compact: true });
            render3DSurface('chart-3d-ssy-sm', r.ssyMat, r.axdist, ribCenters, ribLabels,
                { title: 'σy', colorscale: 'YlOrRd', symmetric: false, compact: true });
            renderBarChart('chart-bar-load', r.al, ribNames, { title: 'Load Factor (αl)', color: 'orange' });
            renderBarChart('chart-bar-stress', r.sigm_Tip, ribNames, { title: 'Stress Factor (σTip) [MPa]', color: 'blue' });
            renderBarChart('chart-bar-width', r.bi, ribNames, { title: 'Width [mm]', color: 'green' });
            buildQuickResults(r);
            chartsNeedRerender.config = false;
        }
        if (mod === 'stress3d') {
            render3DSurface('chart-3d-ssz', r.sszMat, r.axdist, ribCenters, ribLabels,
                { title: 'σz', fullTitle: currentRow.name + ' — Vertical σz', colorscale: 'YlOrRd', symmetric: false });
            render3DSurface('chart-3d-ssx', r.ssxMat, r.axdist, ribCenters, ribLabels,
                { title: 'σx', fullTitle: currentRow.name + ' — Longitudinal σx', colorscale: 'RdBu', symmetric: true });
            render3DSurface('chart-3d-ssy', r.ssyMat, r.axdist, ribCenters, ribLabels,
                { title: 'σy', fullTitle: currentRow.name + ' — Transverse σy', colorscale: 'YlOrRd', symmetric: false });
            const flat_sz = r.sszMat.flat(), flat_sx = r.ssxMat.flat(), flat_sy = r.ssyMat.flat();
            document.getElementById('ssz-subtitle').textContent = `Range: ${Math.min(...flat_sz).toFixed(3)} to ${Math.max(...flat_sz).toFixed(3)} MPa`;
            document.getElementById('ssx-subtitle').textContent = `Range: ${Math.min(...flat_sx).toFixed(3)} to ${Math.max(...flat_sx).toFixed(3)} MPa`;
            document.getElementById('ssy-subtitle').textContent = `Range: ${Math.min(...flat_sy).toFixed(3)} to ${Math.max(...flat_sy).toFixed(3)} MPa`;
            chartsNeedRerender.stress3d = false;
        }
        if (mod === 'analysis') {
            renderHeatmap('chart-hm-ssz', r.sszMat, r.axdist, ribLabels, { title: 'σz', colorscale: 'YlOrRd', symmetric: false });
            renderHeatmap('chart-hm-ssx', r.ssxMat, r.axdist, ribLabels, { title: 'σx', colorscale: 'RdBu', symmetric: true });
            renderHeatmap('chart-hm-ssy', r.ssyMat, r.axdist, ribLabels, { title: 'σy', colorscale: 'YlOrRd', symmetric: false });
            renderRibCurves('chart-rib-ssz', r.SSZ, r.asz, r.xdist, r.axdist, ribLabels, { title: 'σz', symmetric: false });
            renderRibCurves('chart-rib-ssx', r.SSX, r.asx, r.xdist, r.axdist, ribLabels, { title: 'σx', symmetric: true });
            renderRibCurves('chart-rib-ssy', r.SSY, r.asy, r.xdist, r.axdist, ribLabels, { title: 'σy', symmetric: false });
            renderCombinedRib('chart-combined-rib1', r, 0);
            renderPeakComparison('chart-peak-comparison', r);
            renderEqBar('chart-eq-bar', r);
            chartsNeedRerender.analysis = false;
        }
        if (mod === 'summary') {
            buildSummaryTab(r);
            chartsNeedRerender.summary = false;
        }
    }

    function renderAllCharts() {
        if (!results) return;
        Object.keys(chartsNeedRerender).forEach(k => chartsNeedRerender[k] = true);
        renderChartsForModule(getActiveModule());
    }

    // ================================================================
    //  QUICK RESULTS PANEL
    // ================================================================
    function buildQuickResults(r) {
        const panel = document.getElementById('quick-results-panel');
        panel.style.display = '';
        const body = document.getElementById('quick-results-body');
        const passIcon = r.eqPassed
            ? '<span style="color:var(--ac-success);"><i class="fas fa-check-circle"></i> PASSED</span>'
            : '<span style="color:var(--ac-danger);"><i class="fas fa-times-circle"></i> FAILED</span>';

        let html = `
            <table class="results-table">
                <tr><td>Applied Load (P)</td><td class="val">${(r.P / 1000).toFixed(2)} kN</td></tr>
                <tr><td>Calculated Load (P<sub>z</sub>)</td><td class="val">${(r.Calc_Pz / 1000).toFixed(2)} kN</td></tr>
                <tr><td>Difference</td><td class="val">${r.diff.toFixed(3)} %</td></tr>
                <tr><td>Status (≤ 2.5%)</td><td class="val">${passIcon}</td></tr>
            </table>`;
        body.innerHTML = html;
    }

    // ================================================================
    //  SUMMARY TAB
    // ================================================================
    function buildSummaryTab(r) {
        const ribNames = r.bi.map((_, i) => `Rib ${i + 1}`);

        // Stress Distribution Matrix
        let matHtml = '<table class="results-table"><thead><tr><th>Rib</th><th>Width</th><th>α<sub>l</sub></th><th>σ<sub>Tip</sub></th><th>Max σ<sub>z</sub></th><th>Max |σ<sub>x</sub>|</th><th>Max σ<sub>y</sub></th><th>Eq Load</th></tr></thead><tbody>';
        for (let i = 0; i < r.numRibs; i++) {
            const key = 'Rib ' + (i + 1);
            const maxSz = Math.max(...r.SSZ[key]).toFixed(4);
            const maxSx = Math.max(...r.SSX[key].map(Math.abs)).toFixed(4);
            const maxSy = Math.max(...r.SSY[key]).toFixed(4);
            matHtml += `<tr class="rib-row"><td>${ribNames[i]}</td><td class="val">${r.bi[i]}</td><td class="val">${r.al[i].toFixed(4)}</td><td class="val">${r.sigm_Tip[i].toFixed(4)}</td><td class="val" style="color:var(--ac-danger)">${maxSz}</td><td class="val" style="color:var(--ac-primary)">${maxSx}</td><td class="val" style="color:var(--ac-success)">${maxSy}</td><td class="val">${(r.eqPerRib[i] / 1000).toFixed(3)} kN</td></tr>`;
        }
        matHtml += '</tbody></table>';
        document.getElementById('summary-matrix-body').innerHTML = matHtml;

        // Equilibrium
        const passIcon = r.eqPassed
            ? '<span style="color:var(--ac-success);font-weight:700"><i class="fas fa-check-circle"></i> PASSED</span>'
            : '<span style="color:var(--ac-danger);font-weight:700"><i class="fas fa-times-circle"></i> FAILED</span>';
        document.getElementById('summary-eq-body').innerHTML = `
            <table class="results-table">
                <tr><td>Applied Load P</td><td class="val">${(r.P / 1000).toFixed(3)} kN</td></tr>
                <tr><td>Computed P<sub>z</sub></td><td class="val">${(r.Calc_Pz / 1000).toFixed(3)} kN</td></tr>
                <tr><td>Difference</td><td class="val">${r.diff.toFixed(4)} %</td></tr>
                <tr><td>Tolerance (2.5%)</td><td class="val">${passIcon}</td></tr>
            </table>`;

        // Attach export button handler
        document.getElementById('btn-export-xlsx').onclick = function() { exportToExcel(r); };
    }

    // ================================================================
    //  EXPORT TO EXCEL
    // ================================================================
    function exportToExcel(r) {
        const wb = XLSX.utils.book_new();
        const aircraftName = currentRow ? currentRow.name : 'Unknown';

        // ---- Sheet 1: Parameters ----
        const paramData = [
            ['AirCrafter — Contact Stress Analysis Results'],
            [],
            ['Aircraft', aircraftName],
            ['Date', new Date().toLocaleString()],
            [],
            ['Global Parameters'],
            ['Parameter', 'Value', 'Unit'],
            ['Load (P)', r.P, 'N'],
            ['Tire Pressure (TiP)', r.TiP, 'MPa'],
            ['Contact Length (l)', r.l, 'mm'],
            ['Number of Ribs', r.numRibs, ''],
            ['Elements (xn)', r.xn, ''],
            ['Element Length', r.l_elem.toFixed(4), 'mm'],
            [],
            ['Rib Parameters'],
            ['Rib', 'Width bi [mm]', 'αl', 'σ_Tip', 'Eq Load [N]', 'Max σz [MPa]', 'Max |σx| [MPa]', 'Max σy [MPa]'],
        ];
        for (let i = 0; i < r.numRibs; i++) {
            const key = 'Rib ' + (i + 1);
            paramData.push([
                'Rib ' + (i + 1),
                r.bi[i],
                r.al[i],
                r.sigm_Tip[i],
                r.eqPerRib[i],
                Math.max(...r.SSZ[key]),
                Math.max(...r.SSX[key].map(Math.abs)),
                Math.max(...r.SSY[key])
            ]);
        }
        paramData.push([]);
        paramData.push(['Equilibrium Check']);
        paramData.push(['Applied Load P [N]', r.P]);
        paramData.push(['Computed Pz [N]', r.Calc_Pz]);
        paramData.push(['Difference [%]', r.diff]);
        paramData.push(['Status', r.eqPassed ? 'PASSED' : 'FAILED']);
        const wsParams = XLSX.utils.aoa_to_sheet(paramData);
        wsParams['!cols'] = [{wch:22},{wch:16},{wch:14},{wch:14},{wch:14},{wch:16},{wch:16},{wch:16}];
        XLSX.utils.book_append_sheet(wb, wsParams, 'Parameters');

        // ---- Sheet 2: Contact Stresses (single sheet, stacked — matching original Python output) ----
        // Columns = axdist midpoints; Rows = Rib i_j (partitions expanded)
        const colHeaders = r.axdist.map(x => parseFloat(x.toFixed(4)));
        const nElems = r.axdist.length;
        const nearZero = 0.00001;
        const stressData = [];

        // --- SSV block (vertical): all partitions of a rib get identical values ---
        stressData.push(['SSV [MPa]'].concat(colHeaders));
        for (let i = 0; i < r.numRibs; i++) {
            const rib = 'Rib ' + (i + 1);
            for (let j = 0; j < r.nz[i]; j++) {
                stressData.push([rib + '_' + (j + 1)].concat(r.asz[rib]));
            }
        }

        // blank separator
        stressData.push([]);

        // --- SSX block (longitudinal): all partitions of a rib get identical values ---
        stressData.push(['SSX [MPa]'].concat(colHeaders));
        for (let i = 0; i < r.numRibs; i++) {
            const rib = 'Rib ' + (i + 1);
            for (let j = 0; j < r.nz[i]; j++) {
                stressData.push([rib + '_' + (j + 1)].concat(r.asx[rib]));
            }
        }

        // blank separator
        stressData.push([]);

        // --- SSY block (transverse): partition sign logic ---
        // nz=2: part1 = +asy, part2 = -asy
        // nz=3: part1 = +asy, part2 = ~0, part3 = -asy
        // nz=4: part1 = +asy, part2&3 = ~0, part4 = -asy
        stressData.push(['SSY [MPa]'].concat(colHeaders));
        for (let i = 0; i < r.numRibs; i++) {
            const rib = 'Rib ' + (i + 1);
            const nzi = r.nz[i];
            const posVals = r.asy[rib];
            const negVals = posVals.map(v => -1.0 * v);
            const zeroVals = new Array(nElems).fill(nearZero);
            for (let j = 0; j < nzi; j++) {
                let rowVals;
                if (j === 0) {
                    rowVals = posVals;                           // first partition = positive
                } else if (j === nzi - 1) {
                    rowVals = negVals;                           // last partition = negative (flipped)
                } else {
                    rowVals = zeroVals;                          // middle partitions ≈ 0
                }
                stressData.push([rib + '_' + (j + 1)].concat(rowVals));
            }
        }

        const wsStress = XLSX.utils.aoa_to_sheet(stressData);
        wsStress['!cols'] = [{wch:14}].concat(colHeaders.map(() => ({wch:12})));
        XLSX.utils.book_append_sheet(wb, wsStress, 'Contact Stresses');

        // Generate and download
        const safeName = aircraftName.replace(/[^a-zA-Z0-9_\- ]/g, '').replace(/\s+/g, '_');
        XLSX.writeFile(wb, 'AirCrafter_' + safeName + '.xlsx');
        showSuccessFlash('Exported to Excel!');
    }

    // ================================================================
    //  COMPUTE ORCHESTRATOR
    // ================================================================
    function computeAndRender() {
        if (!currentRow) return;
        showLoading('Computing stress distributions...', true);

        requestAnimationFrame(() => {
            try {
                setProgress(20, 'Computing stress distributions...');
                results = computeStresses();
                setProgress(50, 'Updating summaries...');
                updateEquilibriumBadge();
                updateSummaryCards();
                setProgress(75, 'Rendering charts...');
                Object.keys(chartsNeedRerender).forEach(k => chartsNeedRerender[k] = true);
                renderChartsForModule(getActiveModule());
                setProgress(100, 'Complete!');
                ['stress3d-empty','analysis-empty','summary-empty'].forEach(id =>
                    document.getElementById(id).style.display = 'none');
                ['stress3d-content','analysis-content','summary-content'].forEach(id =>
                    document.getElementById(id).style.display = '');
                requestAnimationFrame(() => {
                    hideLoading();
                    showSuccessFlash();
                });
            } catch (e) {
                console.error('Compute error:', e);
                alert('Compute error: ' + e.message);
                hideLoading();
            }
        });
    }

    // ==================== LOADING & FEEDBACK ====================
    function showLoading(msg, useProgress) {
        document.getElementById('loading-text').textContent = msg || 'Loading...';
        const spinner = document.getElementById('loading-spinner');
        const progCont = document.getElementById('progress-container');
        if (useProgress) { spinner.style.display = 'none'; progCont.style.display = ''; setProgress(0); }
        else { spinner.style.display = ''; progCont.style.display = 'none'; }
        document.getElementById('loading-overlay').classList.add('visible');
    }
    function hideLoading() { document.getElementById('loading-overlay').classList.remove('visible'); }
    function setProgress(pct, label) {
        document.getElementById('progress-bar-fill').style.width = pct + '%';
        document.getElementById('progress-pct').textContent = Math.round(pct) + '%';
        if (label) document.getElementById('loading-text').textContent = label;
    }

    // ==================== SELECTION LOADING ====================
    let selectionOverlay = null;
    const selectionSteps = [
        { icon: 'fa-sliders-h', text: 'Loading parameters...' },
        { icon: 'fa-shoe-prints', text: 'Drawing contact patch...' },
        { icon: 'fa-bolt', text: 'Computing stresses...' }
    ];

    function showSelectionLoading(aircraftName) {
        if (selectionOverlay) selectionOverlay.remove();
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
        overlay.id = 'selection-overlay';
        overlay.innerHTML = `
            <div class="selection-loading-card">
                <div class="loading-plane"><i class="fas fa-plane"></i></div>
                <div class="aircraft-name">${aircraftName}</div>
                <div class="loading-steps">
                    ${selectionSteps.map((s, i) => `
                        <div class="loading-step${i === 0 ? ' active' : ''}" id="sel-step-${i}">
                            <i class="fas ${i === 0 ? 'fa-spinner fa-spin' : s.icon}"></i>
                            <span>${s.text}</span>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        document.body.appendChild(overlay);
        selectionOverlay = overlay;
        requestAnimationFrame(() => overlay.classList.add('visible'));
    }

    function updateSelectionStep(completedIdx) {
        if (!selectionOverlay) return;
        for (let i = 0; i <= completedIdx; i++) {
            const step = selectionOverlay.querySelector('#sel-step-' + i);
            if (step) {
                step.className = 'loading-step done';
                step.querySelector('i').className = 'fas fa-check-circle';
            }
        }
        const next = selectionOverlay.querySelector('#sel-step-' + (completedIdx + 1));
        if (next) {
            next.className = 'loading-step active';
            next.querySelector('i').className = 'fas fa-spinner fa-spin';
        }
    }

    function hideSelectionLoading() {
        if (!selectionOverlay) return;
        selectionSteps.forEach((_, i) => {
            const step = selectionOverlay.querySelector('#sel-step-' + i);
            if (step) { step.className = 'loading-step done'; step.querySelector('i').className = 'fas fa-check-circle'; }
        });
        setTimeout(() => {
            if (selectionOverlay) {
                selectionOverlay.classList.remove('visible');
                setTimeout(() => { if (selectionOverlay) { selectionOverlay.remove(); selectionOverlay = null; } }, 300);
            }
        }, 400);
    }

    function showSuccessFlash(msg) {
        const flash = document.createElement('div');
        flash.className = 'success-flash';
        flash.innerHTML = '<i class="fas fa-check-circle"></i> ' + (msg || 'Stresses computed successfully');
        document.body.appendChild(flash);
        setTimeout(() => { flash.style.opacity = '0'; }, 1800);
        setTimeout(() => flash.remove(), 2200);
    }

    // Ripple effect for buttons
    function addRipple(e) {
        const btn = e.currentTarget;
        const rect = btn.getBoundingClientRect();
        const circle = document.createElement('span');
        circle.className = 'ripple-effect';
        const diameter = Math.max(btn.clientWidth, btn.clientHeight);
        circle.style.width = circle.style.height = diameter + 'px';
        circle.style.left = (e.clientX - rect.left - diameter / 2) + 'px';
        circle.style.top = (e.clientY - rect.top - diameter / 2) + 'px';
        btn.appendChild(circle);
        setTimeout(() => circle.remove(), 600);
    }

    // ================================================================
    //  EVENT LISTENERS
    // ================================================================
    document.addEventListener('DOMContentLoaded', function() {

        // Module Tabs — with lazy chart rendering
        document.querySelectorAll('.module-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.module-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.module-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                const mod = this.dataset.module;
                document.getElementById('module-' + mod).classList.add('active');
                // Lazy render: if this tab's charts need re-rendering, do it now
                if (results && chartsNeedRerender[mod]) {
                    requestAnimationFrame(() => renderChartsForModule(mod));
                }
                setTimeout(() => window.dispatchEvent(new Event('resize')), 80);
            });
        });

        // Viz Sub-tabs
        document.querySelectorAll('.viz-tab[data-viz]').forEach(tab => {
            tab.addEventListener('click', function() {
                const parent = this.closest('.module-content');
                parent.querySelectorAll('.viz-tab[data-viz]').forEach(t => t.classList.remove('active'));
                parent.querySelectorAll('.viz-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                parent.querySelector('#viz-' + this.dataset.viz).classList.add('active');
                setTimeout(() => window.dispatchEvent(new Event('resize')), 120);
            });
        });

        // Surface sub-tabs
        document.querySelectorAll('#surface-tabs .viz-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('#surface-tabs .viz-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                const which = this.dataset.surface;
                ['all', 'ssz', 'ssx', 'ssy'].forEach(id => {
                    document.getElementById('surface-' + id).style.display = (which === id) ? '' : 'none';
                });
                setTimeout(() => window.dispatchEvent(new Event('resize')), 120);
            });
        });

        // Filters
        document.getElementById('filter-manufacturer').addEventListener('change', updateAircraftDropdown);
        document.getElementById('aircraft-search').addEventListener('input', updateAircraftDropdown);
        document.getElementById('filter-aircraft').addEventListener('change', onAircraftSelect);

        // Reset & Compute
        document.getElementById('btn-reset').addEventListener('click', function() {
            if (!defaultParams) return;
            applyParams(defaultParams);
            computeAndRender();
        });
        document.getElementById('btn-compute').addEventListener('click', function(e) {
            addRipple(e);
            checkModified();
            computeAndRender();
        });

        // Keyboard shortcut: Ctrl+Enter to compute
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (currentRow) {
                    checkModified();
                    computeAndRender();
                }
            }
        });

        // Advanced toggle
        document.getElementById('adv-toggle').addEventListener('click', function() {
            this.classList.toggle('open');
            document.getElementById('adv-body').classList.toggle('open');
        });

        // Parameter modification detection
        document.getElementById('param-panel').addEventListener('input', function() {
            checkModified();
            updateSummaryCards();
            drawContactPatch();
        });

        // Theme toggle — optimized: use Plotly.relayout for color-only updates
        const toggleBtns = document.querySelectorAll('.theme-toggle, #theme-toggle');
        toggleBtns.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopImmediatePropagation();
                const current = document.documentElement.getAttribute('data-theme');
                const next = current === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('aircrafter-theme', next);
                localStorage.setItem('theme-preference', next);
                if (results) {
                    // Fast relayout: update theme colors on existing plots without full re-render
                    const theme = getPlotlyTheme();
                    document.querySelectorAll('.js-plotly-plot').forEach(el => {
                        try {
                            Plotly.relayout(el, {
                                'paper_bgcolor': theme.paper_bgcolor,
                                'plot_bgcolor': theme.plot_bgcolor,
                                'font.color': theme.font.color,
                                'xaxis.gridcolor': theme.xaxis ? theme.xaxis.gridcolor : undefined,
                                'yaxis.gridcolor': theme.yaxis ? theme.yaxis.gridcolor : undefined,
                                'xaxis.linecolor': theme.xaxis ? theme.xaxis.linecolor : undefined,
                                'yaxis.linecolor': theme.yaxis ? theme.yaxis.linecolor : undefined,
                                'xaxis.zerolinecolor': theme.xaxis ? theme.xaxis.zerolinecolor : undefined,
                                'yaxis.zerolinecolor': theme.yaxis ? theme.yaxis.zerolinecolor : undefined,
                                'xaxis.color': theme.font.color,
                                'yaxis.color': theme.font.color,
                                'hoverlabel.font.color': theme.hoverlabel.font.color,
                                'hoverlabel.bgcolor': theme.hoverlabel.bgcolor,
                                'hoverlabel.bordercolor': theme.hoverlabel.bordercolor
                            });
                        } catch (_) { /* skip non-initialized plots */ }
                    });
                }
                drawContactPatch();
            }, { capture: true });
        });

        // Ripple on all primary buttons
        document.querySelectorAll('.btn-primary').forEach(btn => {
            btn.addEventListener('click', addRipple);
        });

        loadDatabase();
    });

    // ===== Move back-btn into #titleBar on mobile (single instance, no clone) =====
    (function() {
        var restoreParent = null;
        function moveBackBtn() {
            var titleBar = document.getElementById('titleBar');
            var btnInHeader = document.querySelector('.header-nav .back-btn');
            var btnInTitleBar = titleBar ? titleBar.querySelector('.back-btn') : null;
            if (window.innerWidth <= 980 && titleBar) {
                if (btnInTitleBar) { /* already in titleBar */ return; }
                if (btnInHeader) {
                    restoreParent = btnInHeader.parentElement;
                    titleBar.insertBefore(btnInHeader, titleBar.firstChild);
                }
            } else {
                if (btnInTitleBar && restoreParent) {
                    restoreParent.appendChild(btnInTitleBar);
                    restoreParent = null;
                }
            }
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() { setTimeout(moveBackBtn, 100); });
        } else {
            setTimeout(moveBackBtn, 100);
        }
        window.addEventListener('resize', moveBackBtn);
    })();

    // ===== Responsive Plotly resize on viewport change =====
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
            document.querySelectorAll('.js-plotly-plot').forEach(function(el) {
                try { Plotly.Plots.resize(el); } catch(_) {}
            });
        }, 200);
    });
    </script>
</body>
</html>
